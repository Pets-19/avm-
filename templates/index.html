<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Retyn AVM(Automated Valuation Model)</title>
        <link
            rel="icon"
            href="/static/images/favicon.ico"
            type="image/x-icon"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css"
        />
        <link rel="stylesheet" href="/static/css/style.css" />

        <script>
            window.SALES_MAP = {{ sales_map | tojson | safe }};
            window.RENTALS_MAP = {{ rentals_map | tojson | safe }};
        </script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"
            async
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/chart.js"
            async
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"
            async
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
            async
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"
            async
        ></script>
    </head>
    <body>
        <div class="container">
            <div class="app-header">
                <img src="/static/images/Logo.svg" alt="Logo" class="logo" />
                <h1 class="app-title">Retyn AVM (Automated Valuation Model)</h1>
                <div class="user-info">
                    <span class="welcome-text"
                        >Welcome, {{ current_user.name }}!</span
                    >
                    <a href="{{ url_for('logout') }}" class="logout-button"
                        >Sign Out</a
                    >
                </div>
            </div>

            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('buy')">
                    Buy
                </button>
                <button class="tab-button" onclick="switchTab('rent')">
                    Rent
                </button>
                <button class="tab-button" onclick="switchTab('trends')">
                    Market Trends
                </button>
                <button class="tab-button" onclick="switchTab('valuation')">
                    Property Valuation
                </button>
            </div>

            <div id="buy-tab" class="tab-content active">
                <form id="buy-search-form" class="search-form">
                    <div class="form-group">
                        <label for="buy-budget">Maximum Budget (AED)</label
                        ><input
                            type="number"
                            id="buy-budget"
                            value="3000000"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="buy-property-type">Property Type</label>
                        <select id="buy-property-type">
                            <option>All Types</option>
                            <option value="Unit">Unit (Apartment/Flat)</option>
                            <option value="Building">Building</option>
                            <option value="Land">Land</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="buy-bedrooms">Bedrooms</label
                        ><select id="buy-bedrooms">
                            <option>Any</option>
                            <option>Studio</option>
                            <option>1 Bedroom</option>
                            <option>2 Bedrooms</option>
                            <option>3 Bedrooms</option>
                            <option>4 Bedrooms</option>
                            <option>5+ Bedrooms</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="buy-status">Development Status</label
                        ><select id="buy-status">
                            <option>Any</option>
                            <option value="Off-Plan">Off-Plan</option>
                            <option value="Ready">Ready</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="buy-area-search">Area Name</label>
                        <input
                            type="text"
                            id="buy-area-search"
                            placeholder="e.g., Dubai Marina"
                        />
                    </div>
                    <button type="submit" class="search-button">
                        <span>Analyze Sales Market</span>
                    </button>
                </form>
            </div>

            <div id="rent-tab" class="tab-content">
                <form id="rent-search-form" class="search-form">
                    <div class="form-group">
                        <label for="rent-budget">Max Annual Rent (AED)</label
                        ><input
                            type="number"
                            id="rent-budget"
                            value="200000"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="rent-property-type">Property Type</label>
                        <select id="rent-property-type">
                            <option>All Types</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rent-property-sub-type">Property Sub-Type</label>
                        <select id="rent-property-sub-type">
                            <option value="Any">Any</option>
                            <option value="Flat">Flat</option>
                            <option value="Office">Office</option>
                            <option value="Labor Camps">Labor Camps</option>
                            <option value="Shop">Shop</option>
                            <option value="Villa">Villa</option>
                            <option value="Warehouse">Warehouse</option>
                            <option value="Hotel">Hotel</option>
                            <option value="Studio">Studio</option>
                            <option value="Complex Villas">Complex Villas</option>
                            <option value="Showroom">Showroom</option>
                        </select>
                    </div>      
                    

                    <div class="form-group">
                        <label for="rent-area-search">Area Name</label>
                        <input
                            type="text"
                            id="rent-area-search"
                            placeholder="e.g., Jumeirah Lakes Towers"
                        />
                    </div>
                    <button type="submit" class="search-button">
                        <span>Analyze Rental Market</span>
                    </button>
                </form>
            </div>

            <div id="trends-tab" class="tab-content">
                <div class="trends-controls">
                    <div class="form-group">
                        <label for="trend-search-type">Market Type</label>
                        <select id="trend-search-type">
                            <option value="buy">Sales Market</option>
                            <option value="rent">Rental Market</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="trend-period">Time Period</label>
                        <select id="trend-period">
                            <option value="3M">3 Months</option>
                            <option value="6M" selected>6 Months</option>
                            <option value="1Y">1 Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="trend-property-type">Property Type</label>
                        <select id="trend-property-type">
                            <option>All Types</option>
                            <option value="Unit">Unit (Apartment/Flat)</option>
                            <option value="Building">Building</option>
                            <option value="Land">Land</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="trend-bedrooms">Bedrooms</label>
                        <select id="trend-bedrooms">
                            <option>Any</option>
                            <option>Studio</option>
                            <option>1 Bedroom</option>
                            <option>2 Bedrooms</option>
                            <option>3 Bedrooms</option>
                            <option>4 Bedrooms</option>
                            <option>5+ Bedrooms</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="trend-area-search">Area Name</label>
                        <input
                            type="text"
                            id="trend-area-search"
                            placeholder="e.g., Dubai Marina"
                        />
                    </div>
                    <div hidden>
                    <<div class="form-group">
                        <label for="trend-budget">Max Budget (AED)</label>
                        <input
                            type="number"
                            id="trend-budget"
                            value="3000000"
                            placeholder="Enter maximum budget"
                        />
                    </div> </div>

                    <button onclick="loadTrendData()" class="search-button">
                        <span>Analyze Market Trends</span>
                    </button>
                </div>
                
                <div id="trends-loading" class="loading-message" style="display: none;">
                    <p>Analyzing market trends...</p>
                </div>
                
                <div id="trends-content" style="display: none;">
                    <div class="chart-controls">
                        <div class="export-buttons">
                            <button onclick="exportChartAsPNG()" class="export-btn" title="Export as PNG">
                                📊 PNG
                            </button>
                            <button onclick="exportChartAsPDF()" class="export-btn" title="Export as PDF">
                                📄 PDF
                            </button>
                            <button onclick="resetChartZoom()" class="export-btn" title="Reset Zoom">
                                🔍 Reset
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="price-trend-chart" width="800" height="400"></canvas>
                    </div>
                    
                    <div id="trend-insights" class="trend-summary">
                        <h4>Market Trend Analysis</h4>
                        
                        <!-- Basic Metrics -->
                        <div class="trend-metrics">
                            <div class="trend-metric">
                                <span class="metric-label">Market Condition:</span>
                                <span id="market-condition" class="metric-value">-</span>
                            </div>
                            <div class="trend-metric">
                                <span class="metric-label">Price Change:</span>
                                <span id="trend-change" class="metric-value">-</span>
                            </div>
                            <div class="trend-metric">
                                <span class="metric-label">Avg Monthly Volume:</span>
                                <span id="trend-volume" class="metric-value">-</span>
                            </div>
                        </div>

                        <!-- Advanced Analytics -->
                        <h5 style="margin: 20px 0 15px 0; color: #007bff; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">Advanced Analytics</h5>
                        
                        <!-- Quarter-over-Quarter & Year-over-Year -->
                        <div class="trend-metrics">
                            <div class="trend-metric">
                                <span class="metric-label">Quarter-over-Quarter:</span>
                                <span id="qoq-change" class="metric-value">-</span>
                            </div>
                            <div class="trend-metric">
                                <span class="metric-label">Year-over-Year:</span>
                                <span id="yoy-change" class="metric-value">-</span>
                            </div>
                        </div>

                        <!-- Price Stability Indicator -->
                        <div class="trend-metrics">
                            <div class="trend-metric">
                                <span class="metric-label">Price Stability:</span>
                                <span id="price-stability" class="metric-value">-</span>
                            </div>
                        </div>

                        <!-- Market Activity -->
                        <div class="trend-metrics">
                            <div class="trend-metric">
                                <span class="metric-label">Market Activity:</span>
                                <span id="market-activity" class="metric-value">-</span>
                            </div>
                        </div>

                        <!-- Enhanced Metrics -->
                        <h5 style="margin: 20px 0 15px 0; color: #28a745; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">📊 Enhanced Analytics</h5>
                        <div class="trend-metrics">
                            <div class="trend-metric metric-tooltip" data-tooltip="Average monthly price calculated from 6-month historical data to smooth out seasonal variations and provide stable baseline pricing">
                                <span class="metric-label">Avg Monthly Price:</span>
                                <span id="avg-monthly-price" class="metric-value">-</span>
                            </div>
                            <div class="trend-metric metric-tooltip" data-tooltip="Price Momentum measures acceleration or deceleration of price changes - shows if market is speeding up or slowing down">
                                <span class="metric-label">Price Momentum:</span>
                                <span id="price-momentum" class="metric-value">-</span>
                            </div>
                        </div>
                        <div class="trend-metrics">
                            <div class="trend-metric metric-tooltip" data-tooltip="Affordability Index compares current prices to historical baseline (100% = normal) - below 100% means more affordable than usual">
                                <span class="metric-label">Affordability Index:</span>
                                <span id="affordability-index" class="metric-value">-</span>
                            </div>
                            <div class="trend-metric metric-tooltip" data-tooltip="Average price per square meter calculated from historical transaction data - shows market pricing efficiency">
                                <span class="metric-label">Avg Price/SqM:</span>
                                <span id="avg-price-per-sqm" class="metric-value">-</span>
                            </div>
                        </div>

                        <!-- Market Patterns -->
                        <div class="trend-metrics">
                            <div class="trend-metric">
                                <span class="metric-label">Seasonal Pattern:</span>
                                <span id="seasonal-pattern" class="metric-value">-</span>
                            </div>
                            <div class="trend-metric">
                                <span class="metric-label">Data Points:</span>
                                <span id="data-points" class="metric-value">-</span>
                            </div>
                        </div>

                        <div id="trend-summary-text" class="trend-description">
                            <p>Select filters and click "Analyze Market Trends" to view comprehensive price trends and analytics.</p>
                        </div>
                    </div>
                    
                    <!-- Top Performing Areas Section -->
                    <div id="top-areas-section" class="top-areas-container">
                        <h4>🏆 Top Performing Areas by Transaction Volume</h4>
                        <div class="top-areas-controls">
                            <button onclick="loadTopAreasData()" class="search-button small">
                                <span>Load Top Areas</span>
                            </button>
                        </div>
                        <div id="top-areas-loading" class="loading-message" style="display: none;">
                            <p>Loading top performing areas...</p>
                        </div>
                        <div id="top-areas-content" style="display: none;">
                            <div id="top-areas-list" class="areas-ranking-list">
                                <!-- Area rankings will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Trend Indicators Section -->
                    <div id="price-trend-indicators" class="trend-indicators-section" style="display: none;">
                        <h4>📈 Price Trend</h4>
                        <div class="trend-indicators-grid">
                            <div class="trend-card">
                                <span class="trend-label">Current Trend</span>
                                <div class="trend-value">
                                    <span id="price-trend-arrow">→</span>
                                    <span id="price-trend-percentage">--</span>
                                </div>
                            </div>
                            <div class="trend-card">
                                <span class="trend-label">Market Signal</span>
                                <span id="market-signal" class="market-signal">Analyzing</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div
                id="ai-summary-container"
                class="ai-summary"
                style="display: none"
            >
                <div class="ai-header">AI Market Intelligence Dashboard</div>
                <div class="ai-content">
                    <div id="ai-summary-text"></div>
                </div>
            </div>
            <div
                id="analytics-dashboard"
                class="analytics-container"
                style="display: none"
            >
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <h4 id="kpi-title-1">Total Transactions</h4>
                        <p id="total-transactions">0</p>
                    </div>
                    <div class="kpi-card">
                        <h4 id="kpi-title-2">Total Sales Volume (AED)</h4>
                        <p id="total-volume">0</p>
                    </div>
                    <div class="kpi-card">
                        <h4 id="kpi-title-3">Average Sale Price (AED)</h4>
                        <p id="average-price">0</p>
                    </div>
                    <div class="kpi-card">
                        <h4 id="kpi-title-4">Price per Sq.M (AED)</h4>
                        <p id="average-price-per-sqm">0</p>
                        <div id="segment-badge" style="display:none; margin-top:10px; padding:8px 12px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:8px; font-size:13px; font-weight:600; text-align:center; color:white; text-shadow:0 1px 2px rgba(0,0,0,0.3);"></div>
                    </div>
                </div>
            </div>

            <!-- AVM Metrics Dashboard -->
            <div id="avm-dashboard" class="avm-container" style="display: none">
                <h4>AVM Market Intelligence</h4>
                <div class="avm-grid">
                    <div class="avm-card budget-position">
                        <h5>Your Budget Position</h5>
                        <p id="budget-percentile">0%</p>
                        <span id="budget-description">of market covered</span>
                    </div>
                    <div class="avm-card market-median">
                        <h5>Market Median</h5>
                        <p id="market-median">0</p>
                        <span>AED</span>
                    </div>
                    <div class="avm-card volatility">
                        <h5>Price Volatility</h5>
                        <p id="price-volatility">0%</p>
                        <span id="volatility-indicator">market variation</span>
                    </div>
                    <div class="avm-card opportunity">
                        <h5>Opportunities</h5>
                        <p id="affordable-count">0</p>
                        <span>affordable options</span>
                    </div>
                    <div class="avm-card data-quality">
                        <h5>Data Quality</h5>
                        <p id="outliers-filtered">0%</p>
                        <span id="quality-indicator">outliers filtered</span>
                    </div>
                </div>
            </div>
            <!-- Project Filter - Only appears after Buy search results -->
            <div
                id="project-filter-container"
                class="project-filter"
                style="display: none"
            >
                <div class="form-group">
                    <label for="project-filter">Filter by Project Name</label>
                    <select id="project-filter">
                        <option value="">All Projects</option>
                    </select>
                </div>
            </div>

            <div id="valuation-tab" class="tab-content">
                <form id="valuation-form" class="search-form" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; align-items: start;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="valuation-property-type">Property Type</label>
                        <select id="valuation-property-type" required>
                            <option value="">Select Property Type</option>
                            <option value="Unit">Unit (Apartment/Flat)</option>
                            <option value="Villa">Villa</option>
                            <option value="Building">Building</option>
                            <option value="Land">Land</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="valuation-area">Area/Location</label>
                        <input
                            type="text"
                            id="valuation-area"
                            placeholder="e.g., Business Bay"
                            required
                        />
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="valuation-size">Property Size (Square Meters)</label>
                        <input
                            type="number"
                            id="valuation-size"
                            placeholder="e.g., 120.5"
                            step="0.1"
                            min="1"
                            required
                        />
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="valuation-bedrooms">Bedrooms (Optional)</label>
                        <select id="valuation-bedrooms">
                            <option value="">Any</option>
                            <option value="Studio">Studio</option>
                            <option value="1">1 Bedroom</option>
                            <option value="2">2 Bedrooms</option>
                            <option value="3">3 Bedrooms</option>
                            <option value="4">4 Bedrooms</option>
                            <option value="5">5 Bedrooms</option>
                            <option value="6">6+ Bedrooms</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="valuation-status">Development Status (Optional)</label>
                        <select id="valuation-status">
                            <option value="">Any</option>
                            <option value="Ready">Ready</option>
                            <option value="Off-Plan">Off-Plan</option>
                        </select>
                    </div>

                    <!-- PHASE 3: Advanced Options (Optional) - Second Row -->
                    <div style="grid-column: 1 / -1; margin-top: 5px;">
                        <button type="button" class="btn btn-link" onclick="toggleAdvancedOptions()" 
                                style="background: none; border: none; color: #2196F3; padding: 8px 0; cursor: pointer; font-size: 0.9rem; text-decoration: none; display: flex; align-items: center;">
                            <span id="advancedToggleIcon" style="margin-right: 8px; transition: transform 0.3s;">▼</span>
                            <span style="font-weight: 500;">Advanced Property Details (Optional)</span>
                        </button>
                        
                        <div id="advancedOptions" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-top: 10px;">
                            <!-- Floor Level -->
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="floor-level" style="display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem;">
                                    🏢 Floor Level
                                    <span class="tooltip-icon" title="Higher floors typically command premium prices (not applicable for villas)" 
                                          style="margin-left: 5px; cursor: help; color: #666; font-size: 0.85rem;">ⓘ</span>
                                </label>
                                <input type="number" id="floor-level" 
                                       placeholder="e.g., 15" min="0" max="150" 
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                                <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 4px;">Ground floor = 0</small>
                            </div>
                            
                            <!-- View Type -->
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="view-type" style="display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem;">
                                    👁️ View Type
                                    <span class="tooltip-icon" title="View quality significantly impacts property value" 
                                          style="margin-left: 5px; cursor: help; color: #666; font-size: 0.85rem;">ⓘ</span>
                                </label>
                                <select id="view-type" 
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                                    <option value="">Select view...</option>
                                    <option value="Sea View">🌊 Sea View</option>
                                    <option value="Marina View">⛵ Marina View</option>
                                    <option value="Golf Course View">⛳ Golf Course View</option>
                                    <option value="Burj Khalifa View">🏙️ Burj Khalifa View</option>
                                    <option value="Park View">🌳 Park View</option>
                                    <option value="City Skyline">🏢 City Skyline</option>
                                    <option value="Partial Sea View">🌊 Partial Sea View</option>
                                    <option value="Street View">🛣️ Street View</option>
                                </select>
                            </div>
                            
                            <!-- Property Age -->
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="property-age" style="display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem;">
                                    📅 Property Age
                                    <span class="tooltip-icon" title="Newer properties typically have higher valuations. Enter 0 for brand new/off-plan" 
                                          style="margin-left: 5px; cursor: help; color: #666; font-size: 0.85rem;">ⓘ</span>
                                </label>
                                <input type="number" id="property-age" 
                                       placeholder="e.g., 5" min="0" max="100" 
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                                <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 4px;">Years (0 = new/off-plan)</small>
                            </div>
                            
                            <!-- ESG Score Filter (Sustainability) -->
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="esg-score-min" style="display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem;">
                                    🌱 ESG Score (Sustainability)
                                    <span class="tooltip-icon" title="Environmental, Social & Governance rating (0-100). Higher scores indicate better sustainability practices, energy efficiency, and green certifications." 
                                          style="margin-left: 5px; cursor: help; color: #666; font-size: 0.85rem;">ⓘ</span>
                                </label>
                                <select id="esg-score-min" name="esg_score_min" 
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                                    <option value="">Any Score</option>
                                    <option value="25">25+ (Basic) ✓</option>
                                    <option value="40">40+ (Moderate) ✓</option>
                                    <option value="60" disabled style="color: #999;">60+ (High Performance) - No data</option>
                                    <option value="80" disabled style="color: #999;">80+ (Exceptional) - No data</option>
                                </select>
                                <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 4px;">Current ESG data: 25-55 range (2,148 properties)</small>
                            </div>
                            
                            <!-- Flip Score Filter - OPTIONAL -->
                            <div style="grid-column: span 1;">
                                <label for="flip-score-min" style="display: flex; align-items: center; gap: 6px; margin-bottom: 5px; font-weight: 500;">
                                    <span>📈 Flip Score (Investment)</span>
                                </label>
                                <select id="flip-score-min" name="flip_score_min" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Any Score</option>
                                    <option value="30">30+ (Low Potential) ✓</option>
                                    <option value="50">50+ (Moderate) ✓</option>
                                    <option value="70">70+ (Good) ✓</option>
                                    <option value="80">80+ (Excellent) ✓</option>
                                </select>
                                <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 4px;">Current Flip data: 30-88 range (10 properties)</small>
                            </div>
                            
                            <!-- Tip Box - spans remaining column -->
                            <div style="grid-column: span 1; display: flex; align-items: center;">
                                <div style="padding: 10px 15px; background: #fff3cd; border-radius: 4px; font-size: 0.85rem; color: #856404; height: fit-content;">
                                    <strong>💡 Tip:</strong> These optional fields help refine the valuation. Leave blank if unknown.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 6: Arbitrage Score Filter (New Row) -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                            <!-- Arbitrage Score Filter - OPTIONAL -->
                            <div style="grid-column: span 1;">
                                <label for="arbitrage-score-min" style="display: flex; align-items: center; gap: 6px; margin-bottom: 5px; font-weight: 500;">
                                    <span>💰 Arbitrage Score (Value)</span>
                                </label>
                                <select id="arbitrage-score-min" name="arbitrage_score_min" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Any Score</option>
                                    <option value="30">30+ (Good Value) ✓</option>
                                    <option value="50">50+ (Very Good) ✓</option>
                                    <option value="70">70+ (Excellent) ✓</option>
                                    <option value="80">80+ (Outstanding) ✓</option>
                                </select>
                                <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 4px;">Current Arbitrage data: 10-82 range (9 properties)</small>
                            </div>
                            
                            <!-- Empty divs to align with grid -->
                            <div style="grid-column: span 2;"></div>
                        </div>
                    </div>
                    
                    <!-- Submit Button - Full Width -->
                    <div style="grid-column: 1 / -1; margin-top: 15px;">
                        <button type="submit" class="search-button" style="width: 100%;">
                            <span>🏡 Get Property Valuation</span>
                        </button>
                    </div>
                </form>

                <script>
                function toggleAdvancedOptions() {
                    const advancedDiv = document.getElementById('advancedOptions');
                    const icon = document.getElementById('advancedToggleIcon');
                    
                    if (advancedDiv.style.display === 'none' || advancedDiv.style.display === '') {
                        advancedDiv.style.display = 'grid';
                        icon.textContent = '▼';
                    } else {
                        advancedDiv.style.display = 'none';
                        icon.textContent = '▶';
                    }
                }
                // Show advanced options by default
                window.addEventListener('DOMContentLoaded', function() {
                    const advancedDiv = document.getElementById('advancedOptions');
                    if (advancedDiv) {
                        advancedDiv.style.display = 'grid';
                        document.getElementById('advancedToggleIcon').textContent = '▼';
                    }
                });
                </script>

                <!-- Valuation Loading State -->
                <div id="valuation-loading" class="loading-message" style="display: none;">
                    <p>🔍 Analyzing comparable properties and market data...</p>
                </div>

                <!-- Valuation Results -->
                <div id="valuation-results" class="valuation-results-container" style="display: none;">
                    <div class="valuation-header">
                        <h3>Property Valuation Report</h3>
                        <div class="valuation-date">Generated on: <span id="valuation-timestamp"></span></div>
                    </div>

                    <div class="valuation-summary">
                        <div class="valuation-main-card">
                            <div class="estimated-value">
                                <h4>Estimated Market Value</h4>
                                <div class="value-display">
                                    <span class="currency">AED</span>
                                    <span id="estimated-value" class="value">0</span>
                                </div>
                                <div class="confidence-badge">
                                    <span id="confidence-score">0%</span> Confidence
                                </div>
                            </div>
                        </div>

                        <div class="valuation-details-grid">
                            <div class="detail-card">
                                <h5>Price per Sq.M</h5>
                                <p><span id="price-per-sqm">0</span> AED/m²</p>
                                <!-- Segment Badge for Valuation Details -->
                                <div id="segment-badge-details" style="display:none; margin-top:10px; padding:8px 12px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:8px; font-size:12px; font-weight:600; text-align:center; color:white; text-shadow:0 1px 2px rgba(0,0,0,0.3);"></div>
                            </div>
                            <div class="detail-card">
                                <h5>Value Range</h5>
                                <p><span id="value-range-min">0</span> - <span id="value-range-max">0</span> AED</p>
                            </div>
                            <div class="detail-card">
                                <h5>Comparable Properties</h5>
                                <p><span id="comparables-count">0</span> properties analyzed</p>
                            </div>
                            <!-- Rental Yield Card (NEW) -->
                            <div class="detail-card" id="rental-yield-card" style="display: none;">
                                <h5>Gross Rental Yield</h5>
                                <p class="yield-percentage" style="font-size: 2rem; font-weight: bold; color: #4CAF50; margin: 10px 0;">
                                    <span id="rental-yield">--</span>%
                                </p>
                                <p class="yield-subtitle" style="font-size: 0.9rem; color: #666;">
                                    <span id="rental-subtitle">Based on market comparables</span>
                                </p>
                            </div>
                            
                            <!-- PHASE 4: ML Hybrid Valuation Card (NEW) -->
                            <div class="detail-card" id="ml-hybrid-card" style="display: none; border-left: 4px solid #9C27B0;">
                                <h5>🤖 ML Hybrid Valuation</h5>
                                <p style="font-size: 0.85rem; color: #666; margin: 5px 0;">
                                    <span id="ml-method-badge" style="padding: 3px 8px; border-radius: 4px; background: #f3e5f5; color: #6a1b9a; font-weight: 500;">--</span>
                                </p>
                                <details style="font-size: 0.85rem; margin-top: 10px; cursor: pointer;">
                                    <summary style="cursor: pointer; color: #9C27B0; user-select: none;">View Breakdown</summary>
                                    <table style="width: 100%; margin-top: 8px; font-size: 0.8rem;">
                                        <tr><td>ML Price:</td><td id="ml-price" style="text-align: right; font-weight: 500;">--</td></tr>
                                        <tr><td>Rule-Based:</td><td id="rule-based-price" style="text-align: right;">--</td></tr>
                                        <tr><td>ML Confidence:</td><td id="ml-confidence" style="text-align: right;">--</td></tr>
                                        <tr style="border-top: 1px solid #eee;"><td style="padding-top: 5px;"><strong>Final:</strong></td><td id="ml-final-price" style="text-align: right; font-weight: bold; padding-top: 5px;">--</td></tr>
                                    </table>
                                </details>
                            </div>
                            
                            <!-- Property Flip Score Card (NEW - Quick Win Feature) -->
                            <div class="detail-card" id="flip-score-card" style="display: none; border-left: 4px solid #FFC107;">
                                <h5>🏗️ Property Flip Score</h5>
                                <div style="text-align: center; margin: 15px 0;">
                                    <div style="position: relative; display: inline-block; width: 120px; height: 120px;">
                                        <svg width="120" height="120">
                                            <circle cx="60" cy="60" r="50" stroke="#e9ecef" stroke-width="10" fill="none"/>
                                            <circle id="flip-score-progress" cx="60" cy="60" r="50" stroke="#FFC107" stroke-width="10" 
                                                    fill="none" stroke-dasharray="314" stroke-dashoffset="314" 
                                                    transform="rotate(-90 60 60)" style="transition: stroke-dashoffset 1s ease;"/>
                                            <text x="60" y="60" text-anchor="middle" dy=".3em" font-size="24" font-weight="bold" id="flip-score-value">--</text>
                                        </svg>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <h6 id="flip-score-rating" style="margin: 5px 0; color: #333;">--</h6>
                                        <span id="flip-score-confidence" class="badge" style="background: #17a2b8; color: white; padding: 3px 10px;">--</span>
                                    </div>
                                </div>
                                <details style="font-size: 0.85rem; cursor: pointer; margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #FFC107; user-select: none; font-weight: 500;">Score Breakdown</summary>
                                    <div style="margin-top: 10px;">
                                        <div style="margin-bottom: 8px;">
                                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px;">
                                                <span>Price Appreciation (35%)</span>
                                                <span id="appreciation-score" style="font-weight: 500;">--</span>
                                            </div>
                                            <div style="background: #e9ecef; border-radius: 3px; height: 6px; overflow: hidden;">
                                                <div id="appreciation-bar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                                            </div>
                                            <small id="appreciation-details" style="color: #666; font-size: 0.75rem;">--</small>
                                        </div>
                                        <div style="margin-bottom: 8px;">
                                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px;">
                                                <span>Liquidity (25%)</span>
                                                <span id="liquidity-score" style="font-weight: 500;">--</span>
                                            </div>
                                            <div style="background: #e9ecef; border-radius: 3px; height: 6px; overflow: hidden;">
                                                <div id="liquidity-bar" style="background: #17a2b8; height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                                            </div>
                                            <small id="liquidity-details" style="color: #666; font-size: 0.75rem;">--</small>
                                        </div>
                                        <div style="margin-bottom: 8px;">
                                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px;">
                                                <span>Rental Yield (25%)</span>
                                                <span id="yield-score" style="font-weight: 500;">--</span>
                                            </div>
                                            <div style="background: #e9ecef; border-radius: 3px; height: 6px; overflow: hidden;">
                                                <div id="yield-bar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                                            </div>
                                            <small id="yield-details" style="color: #666; font-size: 0.75rem;">--</small>
                                        </div>
                                        <div style="margin-bottom: 8px;">
                                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px;">
                                                <span>Market Position (15%)</span>
                                                <span id="segment-score" style="font-weight: 500;">--</span>
                                            </div>
                                            <div style="background: #e9ecef; border-radius: 3px; height: 6px; overflow: hidden;">
                                                <div id="segment-bar" style="background: #FFC107; height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                                            </div>
                                            <small id="segment-details" style="color: #666; font-size: 0.75rem;">--</small>
                                        </div>
                                    </div>
                                </details>
                                <div id="flip-recommendation" style="background: #fff3cd; border-left: 3px solid #FFC107; padding: 8px; margin-top: 10px; font-size: 0.85rem; border-radius: 3px;">
                                    <strong>Recommendation:</strong> <span id="flip-recommendation-text">--</span>
                                </div>
                                <p id="flip-data-quality" style="font-size: 0.75rem; color: #999; margin-top: 8px; margin-bottom: 0;">Data quality: --</p>
                            </div>
                            
                            <!-- Property Arbitrage Score Card (NEW - Investment Opportunity Detection) -->
                            <div class="detail-card" id="arbitrage-card" style="display: none; border-left: 4px solid #9C27B0;">
                                <h5>💰 Property Arbitrage Score</h5>
                                <div style="text-align: center; margin: 15px 0;">
                                    <div style="position: relative; display: inline-block; width: 120px; height: 120px;">
                                        <svg width="120" height="120">
                                            <circle cx="60" cy="60" r="50" stroke="#e9ecef" stroke-width="10" fill="none"/>
                                            <circle id="arbitrage-progress" cx="60" cy="60" r="50" stroke="#9C27B0" stroke-width="10" 
                                                    fill="none" stroke-dasharray="314" stroke-dashoffset="314" 
                                                    transform="rotate(-90 60 60)" style="transition: stroke-dashoffset 1s ease;"/>
                                            <text x="60" y="60" text-anchor="middle" dy=".3em" font-size="24" font-weight="bold" id="arbitrage-score-value">--</text>
                                        </svg>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <h6 id="arbitrage-rating" style="margin: 5px 0; color: #333;">--</h6>
                                        <span id="arbitrage-confidence" class="badge" style="background: #17a2b8; color: white; padding: 3px 10px;">--</span>
                                    </div>
                                </div>
                                <details style="font-size: 0.85rem; cursor: pointer; margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #9C27B0; user-select: none; font-weight: 500;">Score Breakdown</summary>
                                    <div style="margin-top: 10px;">
                                        <div style="margin-bottom: 12px;">
                                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px;">
                                                <span>💵 Rental Yield (50%)</span>
                                                <span id="arbitrage-yield-score" style="font-weight: 500;">--</span>
                                            </div>
                                            <div style="background: #e9ecef; border-radius: 3px; height: 6px; overflow: hidden;">
                                                <div id="arbitrage-yield-bar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                                            </div>
                                            <small id="arbitrage-yield-details" style="color: #666; font-size: 0.75rem;">--</small>
                                        </div>
                                        <div style="margin-bottom: 12px;">
                                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px;">
                                                <span>📊 Value Spread (50%)</span>
                                                <span id="arbitrage-spread-score" style="font-weight: 500;">--</span>
                                            </div>
                                            <div style="background: #e9ecef; border-radius: 3px; height: 6px; overflow: hidden;">
                                                <div id="arbitrage-spread-bar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                                            </div>
                                            <small id="arbitrage-spread-details" style="color: #666; font-size: 0.75rem;">--</small>
                                        </div>
                                    </div>
                                </details>
                                <div style="background: #f8f9fa; border-radius: 5px; padding: 10px; margin-top: 10px; font-size: 0.8rem;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 5px 0; color: #666;">Your Yield:</td>
                                            <td id="arbitrage-your-yield" style="padding: 5px 0; text-align: right; font-weight: 500;">--</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 5px 0; color: #666;">Market Rent:</td>
                                            <td id="arbitrage-market-rent" style="padding: 5px 0; text-align: right; font-weight: 500;">--</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 5px 0; color: #666;">Your Price:</td>
                                            <td id="arbitrage-asking-price" style="padding: 5px 0; text-align: right; font-weight: 500;">--</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 5px 0; color: #666;">Market Value:</td>
                                            <td id="arbitrage-market-value" style="padding: 5px 0; text-align: right; font-weight: 500;">--</td>
                                        </tr>
                                    </table>
                                </div>
                                <div id="arbitrage-recommendation" style="background: #d1ecf1; border-left: 3px solid #17a2b8; padding: 10px; margin-top: 10px; font-size: 0.85rem; border-radius: 3px;">
                                    <strong>Investment Potential:</strong> <span id="arbitrage-recommendation-text">--</span>
                                </div>
                                <p id="arbitrage-data-quality" style="font-size: 0.75rem; color: #999; margin-top: 8px; margin-bottom: 0;">Data comparables: --</p>
                            </div>
                            
                            <!-- Location Premium Card (NEW - Geospatial) -->
                            <div class="detail-card" id="location-premium-card" style="display: none; border-left: 4px solid #667eea;">
                                <h5>📍 Location Premium</h5>
                                <p style="font-size: 1.8rem; font-weight: bold; margin: 10px 0;">
                                    <span id="location-premium-pct">--</span>%
                                    <span id="location-cache-badge" style="font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-left: 8px; background: #d4edda; color: #155724;">--</span>
                                </p>
                                <details id="location-premium-breakdown" style="font-size: 0.9rem; color: #666; cursor: pointer;">
                                    <summary style="cursor: pointer; color: #667eea; user-select: none;">View Breakdown</summary>
                                    <table style="width: 100%; margin-top: 8px; font-size: 0.85rem; text-align: left;">
                                        <tr><td>Metro Proximity:</td><td id="premium-metro" style="text-align: right;">--</td></tr>
                                        <tr><td>Beach Access:</td><td id="premium-beach" style="text-align: right;">--</td></tr>
                                        <tr><td>Shopping Malls:</td><td id="premium-mall" style="text-align: right;">--</td></tr>
                                        <tr><td>Schools:</td><td id="premium-school" style="text-align: right;">--</td></tr>
                                        <tr><td>Business Districts:</td><td id="premium-business" style="text-align: right;">--</td></tr>
                                        <tr><td>Neighborhood:</td><td id="premium-neighborhood" style="text-align: right;">--</td></tr>
                                    </table>
                                </details>
                            </div>
                            
                            <!-- Project Premium Card (NEW - Luxury Projects) -->
                            <div class="detail-card" id="project-premium-card" style="display: none; border-left: 4px solid #ffc107;">
                                <h5>🏢 Project Premium 
                                    <span id="project-info-icon" style="cursor: pointer; font-size: 0.9rem; color: #ffc107; margin-left: 5px; position: relative;" title="Click to see why">ℹ️</span>
                                </h5>
                                <p style="font-size: 0.9rem; color: #666; margin: 5px 0;">
                                    <strong id="project-premium-name">--</strong>
                                </p>
                                <p style="font-size: 1.8rem; font-weight: bold; margin: 10px 0; color: #ffc107;">
                                    +<span id="project-premium-pct">--</span>%
                                    <span id="premium-trend-badge" style="display: none; font-size: 0.65rem; padding: 3px 8px; border-radius: 12px; margin-left: 8px; background: #d4edda; color: #155724; vertical-align: middle;">
                                        ↑ Up from 8%
                                    </span>
                                    <span id="project-tier-badge" style="font-size: 0.7rem; padding: 4px 10px; border-radius: 4px; margin-left: 8px; background: #fff3cd; color: #856404;">--</span>
                                </p>
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                                    <p style="font-size: 0.85rem; color: #666; margin: 0;">
                                        <strong>Combined Premium:</strong>
                                    </p>
                                    <p style="font-size: 1.3rem; font-weight: bold; margin: 5px 0; color: #28a745;">
                                        +<span id="combined-premium-pct">--</span>%
                                    </p>
                                    <p style="font-size: 0.75rem; color: #999; margin: 5px 0;">
                                        Location + Project
                                    </p>
                                </div>
                                <div style="margin-top: 10px; text-align: center;">
                                    <a href="#" id="view-project-breakdown" style="color: #ffc107; text-decoration: none; font-size: 0.85rem; font-weight: 500;">
                                        🔍 View Full Breakdown
                                    </a>
                                </div>
                            </div>
                            
                            <!-- PHASE 3: Floor Premium Card -->
                            <div class="detail-card" id="floor-premium-card" style="display: none; border-left: 4px solid #2196F3;">
                                <h5>🏢 Floor Premium</h5>
                                <p style="font-size: 0.9rem; color: #666; margin: 5px 0;">
                                    Floor <strong id="floor-number">--</strong>
                                </p>
                                <p style="font-size: 1.5rem; font-weight: bold; margin: 10px 0; color: #2196F3;">
                                    +<span id="floor-premium-pct">--</span>%
                                </p>
                                <p style="font-size: 0.8rem; color: #999;">
                                    Higher floors command premium prices
                                </p>
                            </div>
                            
                            <!-- PHASE 3: View Premium Card -->
                            <div class="detail-card" id="view-premium-card" style="display: none; border-left: 4px solid #00BCD4;">
                                <h5>👁️ View Premium</h5>
                                <p style="font-size: 0.9rem; color: #666; margin: 5px 0;">
                                    <strong id="view-type-display">--</strong>
                                </p>
                                <p style="font-size: 1.5rem; font-weight: bold; margin: 10px 0; color: #00BCD4;">
                                    +<span id="view-premium-pct">--</span>%
                                </p>
                                <p style="font-size: 0.8rem; color: #999;">
                                    Premium view adds significant value
                                </p>
                            </div>
                            
                            <!-- PHASE 3: Age Premium/Depreciation Card -->
                            <div class="detail-card" id="age-premium-card" style="display: none; border-left: 4px solid #9C27B0;">
                                <h5 id="age-card-title">📅 Property Age</h5>
                                <p style="font-size: 0.9rem; color: #666; margin: 5px 0;">
                                    <strong id="age-display">--</strong> years old
                                </p>
                                <p style="font-size: 1.5rem; font-weight: bold; margin: 10px 0;" id="age-premium-value">
                                    <span id="age-premium-pct">--</span>%
                                </p>
                                <p style="font-size: 0.8rem; color: #999;" id="age-description">
                                    Age factor applied to valuation
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="valuation-methodology">
                        <h4>Valuation Methodology</h4>
                        <p>This valuation is based on statistical analysis of comparable properties in the same area and property type. Our algorithm considers:</p>
                        <ul>
                            <li>Recent sales transactions in the area</li>
                            <li>Property size and type similarities</li>
                            <li>Market trends and price fluctuations</li>
                            <li>Location-specific factors</li>
                        </ul>
                    </div>

                    <div class="valuation-disclaimer">
                        <h5>Important Disclaimer</h5>
                        <p><strong>This is an automated valuation model (AVM) estimate for informational purposes only.</strong> The actual market value may vary based on property condition, unique features, market conditions, and other factors not captured in this analysis. For official property valuations, please consult with a certified real estate appraiser.</p>
                    </div>

                    <!-- Project Premium Tooltip -->
                    <div id="project-tooltip" style="display: none; position: absolute; z-index: 1000; background: white; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 320px;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 10px; font-size: 0.95rem;">
                            Why <span id="tooltip-project-name">--</span> is +<span id="tooltip-premium-pct">--</span>%?
                        </div>
                        <div id="tooltip-breakdown" style="font-size: 0.85rem; color: #666; line-height: 1.8;">
                            <!-- Breakdown items will be inserted here -->
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-size: 0.8rem; color: #999;">
                            Based on <span id="tooltip-transaction-count">--</span> transactions
                        </div>
                    </div>

                    <!-- Project Premium Detailed Modal -->
                    <div id="project-premium-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; opacity: 0; transition: opacity 0.3s ease; align-items: center; justify-content: center;">
                        <div style="max-width: 800px; margin: 50px auto; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); transform: translateY(-20px); transition: transform 0.3s ease;">
                            <!-- Modal Header -->
                            <div style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: #000; padding: 25px; border-radius: 12px 12px 0 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3 style="margin: 0; font-size: 1.5rem;">
                                        🏢 <span id="modal-project-name">--</span> Analysis
                                    </h3>
                                    <button id="close-modal-btn" style="background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #000; line-height: 1;">
                                        ×
                                    </button>
                                </div>
                                <p style="margin: 10px 0 0 0; font-size: 0.9rem; opacity: 0.8;">Premium Project Evaluation</p>
                            </div>

                            <!-- Modal Body -->
                            <div style="padding: 30px;">
                                <!-- Overview Section -->
                                <div style="margin-bottom: 30px;">
                                    <h4 style="color: #333; border-bottom: 2px solid #ffc107; padding-bottom: 10px; margin-bottom: 15px;">
                                        📊 Premium Breakdown
                                    </h4>
                                    <p style="color: #666; margin-bottom: 15px;">
                                        <strong><span id="modal-project-name-2">--</span></strong> commands a <strong style="color: #ffc107;">+<span id="modal-premium-pct">--</span>%</strong> premium based on the following factors:
                                    </p>
                                    <div id="modal-breakdown-items" style="margin-top: 15px;">
                                        <!-- Breakdown items will be inserted here -->
                                    </div>
                                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                                        <strong style="color: #856404;">Total Premium: +<span id="modal-total-premium">--</span>%</strong>
                                    </div>
                                </div>

                                <!-- Market Validation Section -->
                                <div style="margin-bottom: 30px;">
                                    <h4 style="color: #333; border-bottom: 2px solid #ffc107; padding-bottom: 10px; margin-bottom: 15px;">
                                        🏆 Market Validation
                                    </h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">Transactions Analyzed</div>
                                            <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">
                                                <span id="modal-transaction-count">--</span>
                                            </div>
                                        </div>
                                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">Average Price</div>
                                            <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">
                                                <span id="modal-avg-price">--</span>
                                            </div>
                                        </div>
                                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">Premium Tier</div>
                                            <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">
                                                <span id="modal-tier">--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Value Impact Section -->
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #333; border-bottom: 2px solid #ffc107; padding-bottom: 10px; margin-bottom: 15px;">
                                        💰 Value Impact
                                    </h4>
                                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span style="color: #666;">Combined Premium:</span>
                                            <strong style="color: #28a745; font-size: 1.1rem;">+<span id="modal-combined-premium">--</span>%</strong>
                                        </div>
                                        <div style="font-size: 0.85rem; color: #999; text-align: right;">
                                            Location (<span id="modal-location-premium">--</span>%) + Project (<span id="modal-project-premium">--</span>%)
                                        </div>
                                    </div>
                                </div>

                                <!-- Similar Premium Projects Section (NEW - Phase 2) -->
                                <div style="margin-bottom: 25px;">
                                    <h4 style="color: #333; border-bottom: 2px solid #ffc107; padding-bottom: 10px; margin-bottom: 15px;">
                                        📊 Similar Premium Projects
                                    </h4>
                                    <div id="similar-projects-container" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <!-- Populated by JavaScript -->
                                        <p style="color: #999; text-align: center; margin: 10px 0;">Loading...</p>
                                    </div>
                                </div>

                                <!-- Close Button -->
                                <div style="text-align: center; margin-top: 30px;">
                                    <button id="download-csv-btn" style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.3s; margin-right: 10px;">
                                        📥 Download CSV
                                    </button>
                                    <button id="close-modal-btn-2" style="padding: 12px 40px; background: #ffc107; color: #000; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s;">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PDF Export Button -->
                    <div class="pdf-export-section" style="margin-top: 30px; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <button id="download-pdf-btn" class="search-button" style="max-width: 350px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <span>📄 Download Valuation Report (PDF)</span>
                        </button>
                        <p style="margin-top: 10px; color: #666; font-size: 0.9em;">Save and share your professional valuation report</p>
                    </div>
                </div>
            </div>

            <div id="results-summary">
                Enter your criteria to analyze the market.
            </div>
            <div id="results-grid" class="results-grid"></div>
        </div>

        <script>
            let activeTab = "buy";
            let isLoading = false;
            let currentProperties = []; // Store current search results for client-side filtering
            let currentSearchType = "";
            let lastValuationData = null; // Store latest valuation data for PDF export
            let lastComparablesData = []; // Store latest comparables for PDF export

            function switchTab(tabName) {
                activeTab = tabName;
                document
                    .querySelectorAll(".tab-button")
                    .forEach((button) => button.classList.remove("active"));
                document
                    .querySelectorAll(".tab-content")
                    .forEach((content) => content.classList.remove("active"));
                document
                    .querySelector(`button[onclick="switchTab('${tabName}')"]`)
                    .classList.add("active");
                document
                    .getElementById(`${tabName}-tab`)
                    .classList.add("active");
                document.getElementById("ai-summary-container").style.display =
                    "none";
                document.getElementById("analytics-dashboard").style.display =
                    "none";
                document.getElementById("avm-dashboard").style.display = "none";
                document.getElementById("results-grid").innerHTML = "";
                document.getElementById("results-summary").textContent =
                    "Enter your criteria to analyze the market.";
                
                // Hide valuation results when switching tabs
                if (tabName !== 'valuation') {
                    document.getElementById("valuation-results").style.display = "none";
                    document.getElementById("valuation-loading").style.display = "none";
                }

                // Hide project filter when switching tabs
                document.getElementById(
                    "project-filter-container"
                ).style.display = "none";
                currentProperties = [];
            }

            document.addEventListener("DOMContentLoaded", async function () {
                try {
                    const [buyAreasRes, rentAreasRes, trendAreasRes, rentPropertyTypesRes] =
                        await Promise.all([
                            fetch("/api/areas/buy"),
                            fetch("/api/areas/rent"),
                            fetch("/api/areas/trends"),
                            fetch("/api/property-types/rent"),
                        ]);
                    const buyAreas = await buyAreasRes.json();
                    const rentAreas = await rentAreasRes.json();
                    const trendAreas = await trendAreasRes.json();
                    const rentPropertyTypes = await rentPropertyTypesRes.json();

                    new Awesomplete(
                        document.getElementById("buy-area-search"),
                        { list: buyAreas }
                    );
                    new Awesomplete(
                        document.getElementById("rent-area-search"),
                        { list: rentAreas }
                    );
                    new Awesomplete(
                        document.getElementById("trend-area-search"),
                        { list: trendAreas }
                    );
                    new Awesomplete(
                        document.getElementById("valuation-area"),
                        { list: buyAreas }
                    );

                    // Load property types for rent tab
                    const rentPropertyTypeSelect =
                        document.getElementById("rent-property-type");
                    rentPropertyTypes.forEach((type) => {
                        const option = document.createElement("option");
                        option.value = type;
                        option.textContent = type;
                        rentPropertyTypeSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Failed to load lists:", error);
                }
            });

            document
                .getElementById("buy-search-form")
                .addEventListener("submit", handleFormSubmit);
            document
                .getElementById("rent-search-form")
                .addEventListener("submit", handleFormSubmit);

            // Add project filter event listener
            document
                .getElementById("project-filter")
                .addEventListener("change", handleProjectFilter);

            async function handleFormSubmit(event) {
                event.preventDefault();
                if (isLoading) return;
                isLoading = true;

                const formId = event.target.id;
                const searchType = formId.startsWith("buy") ? "buy" : "rent";
                const button = event.target.querySelector(".search-button");

                let searchPayload;
                if (searchType === "buy") {
                    searchPayload = {
                        budget: document.getElementById("buy-budget").value,
                        propertyType:
                            document.getElementById("buy-property-type").value,
                        bedrooms: document.getElementById("buy-bedrooms").value,
                        status: document.getElementById("buy-status").value,
                        area: document.getElementById("buy-area-search").value,
                    };
                } else {
                    // rent
                    searchPayload = {
                        annual_rent:
                            document.getElementById("rent-budget").value,
                        propertyType:
                            document.getElementById("rent-property-type").value,
                        property_sub_type:
                            document.getElementById("rent-property-sub-type").value,
                        area: document.getElementById("rent-area-search").value,
                        status: "Any",
                    };
                }

                button.disabled = true;
                button.innerHTML = `<div class="spinner"></div><span>Analyzing...</span>`;

                // Show enhanced loading for AI summary
                const aiContainer = document.getElementById(
                    "ai-summary-container"
                );
                aiContainer.innerHTML = `
                    <div class="ai-summary-loading">
                        <svg class="pl" width="240" height="240" viewBox="0 0 240 240">
                            <circle class="pl__ring pl__ring--a" cx="120" cy="120" r="105" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 660" stroke-dashoffset="-330" stroke-linecap="round"></circle>
                            <circle class="pl__ring pl__ring--b" cx="120" cy="120" r="35" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 220" stroke-dashoffset="-110" stroke-linecap="round"></circle>
                            <circle class="pl__ring pl__ring--c" cx="85" cy="120" r="70" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
                            <circle class="pl__ring pl__ring--d" cx="155" cy="120" r="70" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
                        </svg>
                    </div>
                `;
                aiContainer.style.display = "block";

                document.getElementById("analytics-dashboard").style.display =
                    "none";
                document.getElementById("avm-dashboard").style.display = "none";
                document.getElementById("results-summary").textContent =
                    "Fetching comprehensive market intelligence...";
                document.getElementById("results-grid").innerHTML = "";

                // Hide project filter during new search
                document.getElementById(
                    "project-filter-container"
                ).style.display = "none";
                currentProperties = [];

                try {
                    const searchEndpoint =
                        searchType === "buy" ? "/search" : "/rent-search";
                    const analyticsEndpoint =
                        searchType === "buy"
                            ? "/api/analytics"
                            : "/api/rent-analytics";
                    const avmEndpoint =
                        searchType === "buy"
                            ? "/api/avm-analytics"
                            : "/api/rent-avm-analytics";

                    const [searchResponse, analyticsResponse, avmResponse] =
                        await Promise.all([
                            fetch(searchEndpoint, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(searchPayload),
                            }),
                            fetch(analyticsEndpoint, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(searchPayload),
                            }),
                            fetch(avmEndpoint, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(searchPayload),
                            }),
                        ]);

                    if (!searchResponse.ok || !analyticsResponse.ok) {
                        throw new Error(`Server error`);
                    }

                    const searchResults = await searchResponse.json();
                    const analyticsData = await analyticsResponse.json();
                    const avmData = await avmResponse.json();

                    // Restore the AI summary container structure
                    const aiContainer = document.getElementById(
                        "ai-summary-container"
                    );
                    aiContainer.innerHTML = `
                        <div class="ai-header">
                            Market Intelligence Dashboard
                        </div>
                        <div class="ai-content">
                            <div id="ai-summary-text"></div>
                        </div>
                    `;

                    updateAISummary(searchResults.summary);
                    updateDashboard(analyticsData, searchType);
                    updateAVMDashboard(avmData, searchType);
                    displayListings(searchResults.data, searchType);

                    // Store current results for client-side filtering
                    currentProperties = searchResults.data;
                    currentSearchType = searchType;

                    // Show project filter only for Buy tab
                    if (searchType === "buy") {
                        populateProjectFilter(searchResults.data);
                        // Reset project filter selection
                        document.getElementById("project-filter").value = "";
                    }
                } catch (error) {
                    console.error("Search failed:", error);
                    document.getElementById("results-summary").textContent =
                        "An error occurred during analysis.";
                } finally {
                    isLoading = false;
                    button.disabled = false;
                    button.innerHTML = `<span>Analyze ${
                        searchType === "buy" ? "Sales" : "Rental"
                    } Market</span>`;
                }
            }

            function populateProjectFilter(properties) {
                const projectFilter = document.getElementById("project-filter");
                const projectFilterContainer = document.getElementById(
                    "project-filter-container"
                );

                // Clear existing options except "All Projects"
                projectFilter.innerHTML =
                    '<option value="">All Projects</option>';

                // Get unique project names from current results
                const columnMap = window.SALES_MAP;
                const projectNames = new Set();

                properties.forEach((prop) => {
                    const projectName = prop[columnMap.name];
                    if (projectName && projectName.trim() !== "") {
                        projectNames.add(projectName.trim());
                    }
                });

                // Sort project names alphabetically
                const sortedProjectNames = Array.from(projectNames).sort();

                // Add options to the dropdown
                sortedProjectNames.forEach((projectName) => {
                    const option = document.createElement("option");
                    option.value = projectName;
                    option.textContent = projectName;
                    projectFilter.appendChild(option);
                });

                // Show the project filter container
                if (sortedProjectNames.length > 0) {
                    projectFilterContainer.style.display = "block";
                }
            }

            function handleProjectFilter(event) {
                const selectedProject = event.target.value;

                // Filter properties based on selected project
                let filteredProperties = currentProperties;

                if (selectedProject !== "") {
                    const columnMap = window.SALES_MAP;
                    filteredProperties = currentProperties.filter((prop) => {
                        const projectName = prop[columnMap.name];
                        return (
                            projectName &&
                            projectName.trim() === selectedProject
                        );
                    });
                }

                // Update the display with filtered results
                displayListings(filteredProperties, currentSearchType, true);
            }

            function updateAISummary(summaryText) {
                const summaryContainer = document.getElementById(
                    "ai-summary-container"
                );
                if (summaryText) {
                    // Enhanced AI summary processing
                    const processedSummary =
                        enhanceAISummaryDisplay(summaryText);
                    document.getElementById("ai-summary-text").innerHTML =
                        processedSummary;
                    summaryContainer.style.display = "block";
                }
            }

            function enhanceAISummaryDisplay(rawText) {
                // Convert raw AI text into structured, beautiful HTML
                let processedHTML = rawText;

                // Create executive summary section
                processedHTML = processedHTML.replace(
                    /^(.*?)(?=###|$)/s,
                    '<div class="ai-executive-summary"><h4>Executive Summary</h4><p>$1</p></div>'
                );

                // Process main sections with enhanced styling
                processedHTML = processedHTML.replace(
                    /### Quick Summary\s*\n([\s\S]*?)(?=###|$)/g,
                    '<div class="ai-dashboard-grid"><div class="ai-insight-card market-summary-card"><div class="ai-card-header"><div class="ai-card-icon">💹</div>Market Summary</div><div class="ai-card-content">$1</div></div>'
                );

                processedHTML = processedHTML.replace(
                    /### AVM.*?Analysis\s*\n([\s\S]*?)(?=###|$)/g,
                    '<div class="ai-insight-card avm-insights-card"><div class="ai-card-header"><div class="ai-card-icon">💡</div>AVM Insights</div><div class="ai-card-content">$1</div></div>'
                );

                processedHTML = processedHTML.replace(
                    /### Project Insights\s*\n([\s\S]*?)(?=###|$)/g,
                    '<div class="ai-insight-card project-analysis-card"><div class="ai-card-header"><div class="ai-card-icon">🔎</div>Project Analysis</div><div class="ai-card-content">$1</div></div></div>'
                );

                // Enhanced bullet points
                processedHTML = processedHTML.replace(
                    /- (Market Median|Your Budget Percentile|Affordable Options|Optimal Range|Market Volatility|Area Premium\/Discount):\s*([^\n]+)/g,
                    '<div class="ai-highlight-metric"><span class="metric-label">$1</span><span class="metric-value">$2</span></div>'
                );

                // Convert remaining bullet points to styled lists
                processedHTML = processedHTML.replace(
                    /^- (.+)$/gm,
                    "<li>$1</li>"
                );

                // Wrap consecutive list items in ul tags
                processedHTML = processedHTML.replace(
                    /(<li>.*?<\/li>)(\s*<li>.*?<\/li>)*/gs,
                    '<ul class="ai-bullet-list">$&</ul>'
                );

                // Enhanced strong text styling
                processedHTML = processedHTML.replace(
                    /\*\*(.*?)\*\*/g,
                    "<strong>$1</strong>"
                );

                // Add recommendation boxes for key insights
                processedHTML = processedHTML.replace(
                    /(As a real estate agent.*?)(?=<div|$)/gs,
                    '<div class="ai-recommendation-box">$1</div>'
                );

                // Clean up extra newlines and format
                processedHTML = processedHTML.replace(/\n\n+/g, "</p><p>");
                processedHTML = processedHTML.replace(/\n/g, "<br>");

                return processedHTML;
            }

            function updateDashboard(data, searchType) {
                const dashboard = document.getElementById(
                    "analytics-dashboard"
                );
                if (
                    !data ||
                    !data.stats ||
                    data.stats.total_transactions === null
                ) {
                    dashboard.style.display = "none";
                    return;
                }
                const formatCurrency = (value) =>
                    value
                        ? new Intl.NumberFormat("en-AE", {
                              maximumFractionDigits: 0,
                          }).format(value)
                        : "0";

                document.getElementById("kpi-title-1").textContent =
                    searchType === "buy"
                        ? "Total Transactions"
                        : "Total Rental Contracts";
                document.getElementById("kpi-title-2").textContent =
                    searchType === "buy"
                        ? "Total Sales Volume (AED)"
                        : "Total Rental Volume (AED)";
                document.getElementById("kpi-title-3").textContent =
                    searchType === "buy"
                        ? "Average Sale Price (AED)"
                        : "Average Annual Rent (AED)";
                document.getElementById("kpi-title-4").textContent =
                    "Price per Sq.M (AED)";

                document.getElementById("total-transactions").textContent =
                    data.stats.total_transactions || 0;
                document.getElementById("total-volume").textContent =
                    formatCurrency(data.stats.total_volume);
                document.getElementById("average-price").textContent =
                    formatCurrency(data.stats.average_price);
                document.getElementById("average-price-per-sqm").textContent =
                    formatCurrency(data.stats.average_price_per_sqm);
                dashboard.style.display = "block";
            }

            function updateAVMDashboard(avmResponse, searchType) {
                const avmDashboard = document.getElementById("avm-dashboard");

                if (!avmResponse || !avmResponse.avm_data) {
                    avmDashboard.style.display = "none";
                    return;
                }

                const avm = avmResponse.avm_data;
                const formatCurrency = (value) =>
                    value
                        ? new Intl.NumberFormat("en-AE", {
                              maximumFractionDigits: 0,
                          }).format(value)
                        : "0";

                // Update budget percentile
                document.getElementById(
                    "budget-percentile"
                ).textContent = `${avm.budget_percentile.toFixed(1)}%`;

                // Update market median
                document.getElementById("market-median").textContent =
                    formatCurrency(avm.stats.median_price);

                // Update volatility with color coding
                const volatility = avm.price_volatility.toFixed(1);
                const volatilityElement =
                    document.getElementById("price-volatility");
                const volatilityIndicator = document.getElementById(
                    "volatility-indicator"
                );

                volatilityElement.textContent = `${volatility}%`;

                if (avm.price_volatility < 15) {
                    volatilityIndicator.textContent = "stable market";
                    volatilityElement.style.color = "#28a745";
                } else if (avm.price_volatility < 30) {
                    volatilityIndicator.textContent = "moderate variation";
                    volatilityElement.style.color = "#fd7e14";
                } else {
                    volatilityIndicator.textContent = "high variation";
                    volatilityElement.style.color = "#dc3545";
                }

                // Update opportunities
                document.getElementById("affordable-count").textContent =
                    avm.affordable_count;

                // 🔥 NEW: Update data quality information
                if (avm.outlier_info) {
                    const outliersFilteredElement =
                        document.getElementById("outliers-filtered");
                    const qualityIndicatorElement =
                        document.getElementById("quality-indicator");

                    const outlierPercentage =
                        avm.outlier_info.outlier_percentage.toFixed(1);
                    outliersFilteredElement.textContent = `${outlierPercentage}%`;

                    // Color code based on outlier percentage
                    if (avm.outlier_info.outlier_percentage < 5) {
                        qualityIndicatorElement.textContent =
                            "excellent quality";
                        outliersFilteredElement.style.color = "#28a745";
                    } else if (avm.outlier_info.outlier_percentage < 15) {
                        qualityIndicatorElement.textContent = "good quality";
                        outliersFilteredElement.style.color = "#17a2b8";
                    } else {
                        qualityIndicatorElement.textContent =
                            "filtered for accuracy";
                        outliersFilteredElement.style.color = "#fd7e14";
                    }
                }

                avmDashboard.style.display = "block";
            }

            function displayListings(
                properties,
                searchType,
                isFiltered = false
            ) {
                const resultsSummary =
                    document.getElementById("results-summary");
                const resultsGrid = document.getElementById("results-grid");
                const summaryNoun =
                    searchType === "buy" ? "transactions" : "contracts";

                // Update summary text based on whether it's filtered or not
                if (isFiltered && searchType === "buy") {
                    const selectedProject =
                        document.getElementById("project-filter").value;
                    if (selectedProject) {
                        resultsSummary.textContent = `Showing ${properties.length} ${summaryNoun} from "${selectedProject}" project.`;
                    } else {
                        resultsSummary.textContent = `Found ${properties.length} individual ${summaryNoun} matching your criteria.`;
                    }
                } else {
                    resultsSummary.textContent = `Found ${properties.length} individual ${summaryNoun} matching your criteria.`;
                }

                resultsGrid.innerHTML = "";

                if (!properties || properties.length === 0) {
                    resultsGrid.innerHTML = `<p>No individual ${summaryNoun} found.</p>`;
                    return;
                }

                const columnMap =
                    searchType === "buy"
                        ? window.SALES_MAP
                        : window.RENTALS_MAP;
                const priceKey =
                    searchType === "buy" ? columnMap.price : "trans_value";

                properties.forEach((prop) => {
                    const card = document.createElement("div");
                    card.className = "property-card";
                    const priceValue = prop[priceKey];
                    const price = !isNaN(priceValue)
                        ? new Intl.NumberFormat("en-AE", {
                              style: "currency",
                              currency: "AED",
                          }).format(priceValue)
                        : "N/A";
                    const propName = prop[columnMap.name] || "Property Listing";
                    const areaName =
                        prop[columnMap.area_name] || "Area not specified";
                    const propertyType = prop[columnMap.property_type] || "N/A";

                    // Format transaction date
                    let dateHtml = "";
                    const dateField =
                        searchType === "buy"
                            ? "instance_date"
                            : "registration_date";
                    const rawDate = prop[dateField];
                    if (rawDate) {
                        const formattedDate = new Date(
                            rawDate
                        ).toLocaleDateString("en-US", {
                            year: "numeric",
                            month: "short",
                            day: "numeric",
                        });
                        const dateLabel =
                            searchType === "buy"
                                ? "Transaction Date:"
                                : "Registration Date:";
                        dateHtml = `<p class="date-field"><strong>${dateLabel}</strong> ${formattedDate}</p>`;
                    }

                    let bedroomsHtml = "";
                    if (searchType === "buy" && columnMap.bedrooms) {
                        const beds = prop[columnMap.bedrooms] || "N/A";
                        bedroomsHtml = `<p><strong>Bedrooms:</strong> ${beds}</p>`;
                    }

                    card.innerHTML = `
                    <h3>${propName}</h3>
                    <div class="card-details">
                        <p><strong>${
                            searchType === "buy" ? "Price:" : "Annual Rent:"
                        }</strong> ${price}</p>
                        <p><strong>Area:</strong> ${areaName}</p>
                        <p><strong>Property Type:</strong> ${propertyType}</p>
                        ${bedroomsHtml}
                        ${dateHtml}
                    </div>
                `;
                    resultsGrid.appendChild(card);
                });
            }

            // Market Trends Functionality
            let trendChart = null;

            function loadTrendData() {
                const searchType = document.getElementById('trend-search-type').value;
                const timePeriod = document.getElementById('trend-period').value;
                const propertyType = document.getElementById('trend-property-type').value;
                const bedrooms = document.getElementById('trend-bedrooms').value;
                const area = document.getElementById('trend-area-search').value;
                const budget = document.getElementById('trend-budget').value;

                // Show loading
                document.getElementById('trends-loading').style.display = 'block';
                document.getElementById('trends-content').style.display = 'none';

                // Prepare filters based on search type
                const filters = {
                    search_type: searchType,
                    time_period: timePeriod,
                    propertyType: propertyType === 'All Types' ? '' : propertyType,
                    bedrooms: bedrooms === 'Any' ? '' : bedrooms,
                    area: area,
                    budget: parseInt(budget) || 999999999
                };

                // Add budget field based on search type
                if (searchType === 'rent') {
                    filters.annual_rent = parseInt(budget) || 999999999;
                } else {
                    filters.budget = parseInt(budget) || 999999999;
                }

                console.log('Loading trend data with filters:', filters);

                fetch('/api/trends/price-timeline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filters)
                })
                .then(response => {
                    // Check if response is HTML (login redirect) instead of JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('text/html')) {
                        // User is not logged in, redirect to login
                        window.location.href = '/login';
                        return Promise.reject(new Error('Authentication required'));
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Trend data received:', data);
                    document.getElementById('trends-loading').style.display = 'none';
                    
                    if (data.status === 'success' && data.timeline && data.timeline.length > 0) {
                        document.getElementById('trends-content').style.display = 'block';
                        renderTrendChart(data.timeline, searchType);
                        updateTrendSummary(data.summary);
                        updatePriceTrendIndicators(data.timeline);
                    } else {
                        document.getElementById('trends-content').style.display = 'block';
                        showTrendError(data.summary?.summary || 'No trend data available for the selected criteria.');
                    }
                })
                .catch(error => {
                    console.error('Error loading trend data:', error);
                    document.getElementById('trends-loading').style.display = 'none';
                    document.getElementById('trends-content').style.display = 'block';
                    showTrendError('Error loading trend data. Please try again.');
                });
            }

            function renderTrendChart(timelineData, searchType) {
                const ctx = document.getElementById('price-trend-chart');
                
                // Destroy existing chart if it exists
                if (trendChart) {
                    trendChart.destroy();
                }

                // Prepare chart data
                const labels = timelineData.map(point => {
                    const date = new Date(point.month + '-01');
                    return date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short' 
                    });
                });
                
                const prices = timelineData.map(point => point.avg_price);
                const volumes = timelineData.map(point => point.transaction_count);

                // Create datasets
                const datasets = [{
                    label: `Average ${searchType === 'buy' ? 'Sale' : 'Rental'} Price (AED)`,
                    data: prices,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#007bff',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    yAxisID: 'y'
                }];

                // Add volume dataset if data exists
                if (volumes.some(v => v > 0)) {
                    datasets.push({
                        label: 'Transaction Volume',
                        data: volumes,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        pointBackgroundColor: '#28a745',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        yAxisID: 'y1'
                    });
                }

                // Create the chart
                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    plugins: [window.ChartZoom],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            zoom: {
                                zoom: {
                                    wheel: {
                                        enabled: true,
                                        speed: 0.1
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'x',
                                    onZoomComplete: function({chart}) {
                                        // Update chart title to show zoom status
                                        const zoomLevel = chart.getZoomLevel();
                                        if (zoomLevel > 1) {
                                            chart.options.plugins.title.text = 
                                                `Market Price Trends - ${searchType === 'buy' ? 'Sales' : 'Rental'} Market (Zoomed)`;
                                        } else {
                                            chart.options.plugins.title.text = 
                                                `Market Price Trends - ${searchType === 'buy' ? 'Sales' : 'Rental'} Market`;
                                        }
                                        chart.update('none');
                                    }
                                },
                                pan: {
                                    enabled: true,
                                    mode: 'x',
                                    threshold: 10
                                }
                            },
                            title: {
                                display: true,
                                text: `Market Price Trends - ${searchType === 'buy' ? 'Sales' : 'Rental'} Market`,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#007bff',
                                borderWidth: 1,
                                cornerRadius: 6,
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        const index = context[0].dataIndex;
                                        const date = new Date(timelineData[index].month + '-01');
                                        return date.toLocaleDateString('en-US', { 
                                            year: 'numeric', 
                                            month: 'long'
                                        });
                                    },
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        if (context.datasetIndex === 0) {
                                            // Price data
                                            return `${context.dataset.label}: ${new Intl.NumberFormat('en-AE', {
                                                style: 'currency',
                                                currency: 'AED',
                                                minimumFractionDigits: 0
                                            }).format(value)}`;
                                        } else {
                                            // Volume data
                                            return `${context.dataset.label}: ${value.toLocaleString()}`;
                                        }
                                    },
                                    afterBody: function(context) {
                                        const index = context[0].dataIndex;
                                        const data = timelineData[index];
                                        let info = [];
                                        
                                        if (data.property_count) {
                                            info.push(`Properties Listed: ${data.property_count.toLocaleString()}`);
                                        }
                                        
                                        if (data.avg_size) {
                                            info.push(`Avg Size: ${Math.round(data.avg_size)} sq ft`);
                                        }
                                        
                                        return info.length > 0 ? info : '';
                                    },
                                    footer: function(context) {
                                        return 'Scroll to zoom • Drag to pan • Double-click to reset';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Time Period'
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Price (AED)'
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('en-AE', {
                                            style: 'currency',
                                            currency: 'AED',
                                            minimumFractionDigits: 0,
                                            notation: 'compact'
                                        }).format(value);
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: volumes.some(v => v > 0),
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Transaction Volume'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        },
                        onDoubleClick: function(event, elements) {
                            // Reset zoom on double click
                            trendChart.resetZoom();
                        }
                    }
                });
            }

            // Chart export and control functions
            function exportChartAsPNG() {
                if (!trendChart) {
                    alert('No chart available to export');
                    return;
                }

                const canvas = document.getElementById('price-trend-chart');
                const link = document.createElement('a');
                link.download = `market-trends-${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }

            function exportChartAsPDF() {
                if (!trendChart) {
                    alert('No chart available to export');
                    return;
                }

                const canvas = document.getElementById('price-trend-chart');
                const chartContainer = document.querySelector('.chart-container');
                
                // Create a temporary container for the full export
                const tempContainer = document.createElement('div');
                tempContainer.style.width = '800px';
                tempContainer.style.padding = '20px';
                tempContainer.style.backgroundColor = 'white';
                tempContainer.style.fontFamily = 'Inter, sans-serif';
                
                // Add title
                const title = document.createElement('h2');
                title.textContent = 'Dubai Real Estate Market Trends Report';
                title.style.textAlign = 'center';
                title.style.marginBottom = '20px';
                title.style.color = '#007bff';
                
                // Add date
                const date = document.createElement('p');
                date.textContent = `Generated on: ${new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}`;
                date.style.textAlign = 'center';
                date.style.marginBottom = '30px';
                date.style.color = '#6c757d';
                
                tempContainer.appendChild(title);
                tempContainer.appendChild(date);
                
                // Clone chart canvas
                const chartClone = canvas.cloneNode(true);
                chartClone.style.maxWidth = '100%';
                chartClone.style.height = 'auto';
                tempContainer.appendChild(chartClone);
                
                // Add trend summary if available
                const trendSummary = document.getElementById('trend-insights');
                if (trendSummary) {
                    const summaryClone = trendSummary.cloneNode(true);
                    summaryClone.style.marginTop = '20px';
                    tempContainer.appendChild(summaryClone);
                }
                
                document.body.appendChild(tempContainer);
                
                html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: 'white'
                }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`market-trends-report-${new Date().toISOString().split('T')[0]}.pdf`);
                    document.body.removeChild(tempContainer);
                });
            }

            function resetChartZoom() {
                if (trendChart) {
                    trendChart.resetZoom();
                }
            }

            function updateTrendSummary(summary) {
                // Update merged market condition
                const trendDirection = summary.trend_direction?.replace('_', ' ').toUpperCase() || 'Unknown';
                const changeText = summary.percentage_change !== undefined 
                    ? `${summary.percentage_change > 0 ? '+' : ''}${summary.percentage_change}%`
                    : 'N/A';
                
                document.getElementById('market-condition').textContent = 
                    `${trendDirection} (${changeText})`;
                
                document.getElementById('trend-change').textContent = changeText;
                
                const volumeText = summary.avg_monthly_volume 
                    ? `${Math.round(summary.avg_monthly_volume)} transactions`
                    : 'N/A';
                document.getElementById('trend-volume').textContent = volumeText;

                // Update Quarter-over-Quarter
                const qoqText = summary.qoq_change !== undefined && summary.qoq_status !== 'N/A'
                    ? `${summary.qoq_status} (${summary.qoq_change > 0 ? '+' : ''}${summary.qoq_change}%)`
                    : 'N/A';
                document.getElementById('qoq-change').textContent = qoqText;

                // Update Year-over-Year
                const yoyText = summary.yoy_change !== undefined && summary.yoy_status !== 'N/A'
                    ? `${summary.yoy_status} (${summary.yoy_change > 0 ? '+' : ''}${summary.yoy_change}%)`
                    : 'N/A';
                document.getElementById('yoy-change').textContent = yoyText;

                // Update Price Stability Indicator
                const priceStabilityText = summary.volatility_index && summary.price_std !== undefined && summary.volatility !== undefined
                    ? `${summary.volatility_index} (±${new Intl.NumberFormat('en-AE', {
                        style: 'currency',
                        currency: 'AED',
                        minimumFractionDigits: 0,
                        notation: 'compact'
                    }).format(summary.price_std)}, ${summary.volatility}% volatility)`
                    : 'N/A';
                document.getElementById('price-stability').textContent = priceStabilityText;

                // Update Market Activity
                const marketActivityText = summary.volume_trend && summary.volume_change !== undefined && summary.volume_growth_rate !== undefined
                    ? `${summary.volume_trend} (${summary.volume_change > 0 ? '+' : ''}${summary.volume_change}%, ${summary.volume_growth_rate > 0 ? '+' : ''}${summary.volume_growth_rate}%/month)`
                    : 'N/A';
                document.getElementById('market-activity').textContent = marketActivityText;

                // Update Enhanced Metrics
                const avgPriceText = summary.avg_monthly_price !== undefined
                    ? new Intl.NumberFormat('en-AE', {
                        style: 'currency',
                        currency: 'AED',
                        minimumFractionDigits: 0,
                        notation: 'compact'
                    }).format(summary.avg_monthly_price)
                    : 'N/A';
                document.getElementById('avg-monthly-price').textContent = avgPriceText;

                document.getElementById('price-momentum').textContent = summary.price_momentum || 'N/A';

                const affordabilityText = summary.affordability_index !== undefined
                    ? `${summary.affordability_index}% of baseline`
                    : 'N/A';
                document.getElementById('affordability-index').textContent = affordabilityText;

                // Update Average Price per SqM
                const avgPricePerSqmText = summary.avg_price_per_sqm !== undefined && summary.avg_price_per_sqm > 0
                    ? `${new Intl.NumberFormat('en-AE', {
                        style: 'currency',
                        currency: 'AED',
                        minimumFractionDigits: 0
                    }).format(summary.avg_price_per_sqm)} ${summary.price_per_sqm_change !== undefined && summary.price_per_sqm_change != 0 ? `(${summary.price_per_sqm_change > 0 ? '↑' : '↓'}${summary.price_per_sqm_change > 0 ? '+' : ''}${summary.price_per_sqm_change.toFixed(1)}%)` : ''}`
                    : 'N/A';
                document.getElementById('avg-price-per-sqm').textContent = avgPricePerSqmText;

                // Update Market Patterns
                document.getElementById('seasonal-pattern').textContent = summary.seasonal_pattern || 'N/A';
                document.getElementById('data-points').textContent = summary.data_points || 'N/A';
                
                // Update summary text
                document.getElementById('trend-summary-text').innerHTML = 
                    `<p>${summary.summary || 'Comprehensive trend analysis completed.'}</p>`;
                
                // Color-code the market condition
                const conditionElement = document.getElementById('market-condition');
                conditionElement.className = 'metric-value';
                if (summary.trend_direction === 'upward') {
                    conditionElement.classList.add('trend-up');
                } else if (summary.trend_direction === 'downward') {
                    conditionElement.classList.add('trend-down');
                } else {
                    conditionElement.classList.add('trend-stable');
                }

                // Color-code QoQ changes
                const qoqElement = document.getElementById('qoq-change');
                qoqElement.className = 'metric-value';
                if (summary.qoq_change > 0) {
                    qoqElement.classList.add('trend-up');
                } else if (summary.qoq_change < 0) {
                    qoqElement.classList.add('trend-down');
                } else {
                    qoqElement.classList.add('trend-stable');
                }

                // Color-code YoY changes
                const yoyElement = document.getElementById('yoy-change');
                yoyElement.className = 'metric-value';
                if (summary.yoy_change > 0) {
                    yoyElement.classList.add('trend-up');
                } else if (summary.yoy_change < 0) {
                    yoyElement.classList.add('trend-down');
                } else {
                    yoyElement.classList.add('trend-stable');
                }

                // Color-code price stability
                const priceStabilityElement = document.getElementById('price-stability');
                priceStabilityElement.className = 'metric-value';
                if (summary.volatility_index === 'High') {
                    priceStabilityElement.classList.add('trend-down'); // High volatility = red
                } else if (summary.volatility_index === 'Moderate') {
                    priceStabilityElement.classList.add('trend-stable'); // Moderate = yellow
                } else {
                    priceStabilityElement.classList.add('trend-up'); // Low volatility = green
                }

                // Color-code market activity
                const marketActivityElement = document.getElementById('market-activity');
                marketActivityElement.className = 'metric-value';
                if (summary.volume_trend === 'Increasing') {
                    marketActivityElement.classList.add('trend-up');
                } else if (summary.volume_trend === 'Decreasing') {
                    marketActivityElement.classList.add('trend-down');
                } else {
                    marketActivityElement.classList.add('trend-stable');
                }

                // Color-code Enhanced Metrics
                // Price Momentum color coding
                const momentumElement = document.getElementById('price-momentum');
                momentumElement.className = 'metric-value';
                if (summary.price_momentum === 'Accelerating') {
                    momentumElement.classList.add('trend-up');
                } else if (summary.price_momentum === 'Decelerating') {
                    momentumElement.classList.add('trend-down');
                } else {
                    momentumElement.classList.add('trend-stable');
                }

                // Affordability Index color coding
                const affordabilityElement = document.getElementById('affordability-index');
                affordabilityElement.className = 'metric-value';
                if (summary.affordability_index !== undefined) {
                    if (summary.affordability_index < 90) {
                        affordabilityElement.classList.add('trend-up'); // More affordable = green
                    } else if (summary.affordability_index > 110) {
                        affordabilityElement.classList.add('trend-down'); // Less affordable = red
                    } else {
                        affordabilityElement.classList.add('trend-stable'); // Around baseline = yellow
                    }
                }
            }

            // Update price trend indicators
            function updatePriceTrendIndicators(trendData) {
                // Define constants for trend thresholds
                const TREND_THRESHOLDS = {
                    ARROW_CHANGE: 2,      // Minimum change for directional arrows
                    STRONG_GROWTH: 5,     // Threshold for "Strong Growth" signal
                    STRONG_DECLINE: -5,   // Threshold for "Declining" signal
                    MIN_PRICE: 1000       // Minimum valid price to prevent division issues
                };

                const indicatorsSection = document.getElementById('price-trend-indicators');
                const arrow = document.getElementById('price-trend-arrow');
                const percentage = document.getElementById('price-trend-percentage');
                const signal = document.getElementById('market-signal');
                
                // Enhanced data validation
                if (!trendData || trendData.length < 2) {
                    indicatorsSection.style.display = 'none';
                    return;
                }
                
                const latest = trendData[trendData.length - 1];
                const previous = trendData[trendData.length - 2];
                
                // Safety checks for data integrity
                if (!latest || !previous || 
                    typeof latest.avg_price !== 'number' || 
                    typeof previous.avg_price !== 'number' ||
                    latest.avg_price < 0 || previous.avg_price < 0) {
                    indicatorsSection.style.display = 'none';
                    return;
                }
                
                // Division by zero protection and percentage calculation
                const changePercent = previous.avg_price > TREND_THRESHOLDS.MIN_PRICE 
                    ? ((latest.avg_price - previous.avg_price) / previous.avg_price * 100)
                    : 0;
                
                // Apply trend logic with constants
                arrow.textContent = changePercent > TREND_THRESHOLDS.ARROW_CHANGE ? '↗️' : 
                                  changePercent < -TREND_THRESHOLDS.ARROW_CHANGE ? '↘️' : '→';
                arrow.className = changePercent > 0 ? 'trend-up' : 
                                changePercent < 0 ? 'trend-down' : 'trend-stable';
                percentage.textContent = `${Math.abs(changePercent).toFixed(1)}%`;
                percentage.className = arrow.className;
                
                signal.textContent = changePercent > TREND_THRESHOLDS.STRONG_GROWTH ? 'Strong Growth' : 
                                   changePercent < TREND_THRESHOLDS.STRONG_DECLINE ? 'Declining' : 'Stable';
                signal.className = `market-signal ${arrow.className}`;
                indicatorsSection.style.display = 'block';
            }

            function showTrendError(message) {
                // Clear basic metrics
                document.getElementById('market-condition').textContent = 'Error';
                document.getElementById('trend-change').textContent = 'N/A';
                document.getElementById('trend-volume').textContent = 'N/A';
                
                // Clear advanced analytics
                document.getElementById('qoq-change').textContent = 'N/A';
                document.getElementById('yoy-change').textContent = 'N/A';
                document.getElementById('price-stability').textContent = 'N/A';
                document.getElementById('market-activity').textContent = 'N/A';
                document.getElementById('seasonal-pattern').textContent = 'N/A';
                document.getElementById('data-points').textContent = 'N/A';
                
                // Clear enhanced metrics
                document.getElementById('avg-monthly-price').textContent = 'N/A';
                document.getElementById('price-momentum').textContent = 'N/A';
                document.getElementById('affordability-index').textContent = 'N/A';
                
                document.getElementById('trend-summary-text').innerHTML = `<p style="color: #dc3545;">${message}</p>`;
                
                // Clear chart
                if (trendChart) {
                    trendChart.destroy();
                    trendChart = null;
                }
            }

            // Top Areas Functionality
            function loadTopAreasData() {
                const searchType = document.getElementById('trend-search-type').value;
                const timePeriod = document.getElementById('trend-period').value;
                
                console.log('Loading top areas data for:', searchType, 'with time period:', timePeriod);
                
                // Show loading
                document.getElementById('top-areas-loading').style.display = 'block';
                document.getElementById('top-areas-content').style.display = 'none';
                document.getElementById('top-areas-section').style.display = 'block';
                
                const requestData = {
                    search_type: searchType,
                    time_period: timePeriod,
                    limit: 10
                };
                
                fetch('/api/top-areas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Top areas data received:', data);
                    document.getElementById('top-areas-loading').style.display = 'none';
                    
                    if (data.top_areas && data.top_areas.length > 0) {
                        document.getElementById('top-areas-content').style.display = 'block';
                        renderTopAreasList(data.top_areas, searchType);
                    } else {
                        document.getElementById('top-areas-content').style.display = 'block';
                        showTopAreasError(data.error || 'No areas data available.');
                    }
                })
                .catch(error => {
                    console.error('Error loading top areas data:', error);
                    document.getElementById('top-areas-loading').style.display = 'none';
                    document.getElementById('top-areas-content').style.display = 'block';
                    showTopAreasError('Failed to load top areas data.');
                });
            }

            function renderTopAreasList(areasData, searchType) {
                const container = document.getElementById('top-areas-list');
                container.innerHTML = '';
                
                areasData.forEach((area, index) => {
                    const rankingItem = document.createElement('div');
                    rankingItem.className = 'ranking-item';
                    
                    const formattedPrice = new Intl.NumberFormat('en-AE', {
                        style: 'currency',
                        currency: 'AED',
                        maximumFractionDigits: 0
                    }).format(area.avg_price);
                    
                    // Debug: Check all available fields
                    console.log('🔍 All fields in area object:', Object.keys(area));
                    console.log('🔍 Full area object:', area);
                    
                    // Format price per sqm with debugging
                    console.log('🔍 Area:', area.area_name);
                    console.log('🔍 avg_price_per_sqm value:', area.avg_price_per_sqm);
                    console.log('🔍 typeof avg_price_per_sqm:', typeof area.avg_price_per_sqm);
                    console.log('🔍 market_share_percentage value:', area.market_share_percentage);
                    
                    // TEMPORARY FIX: Use market_share_percentage if it contains price per sqm data
                    let pricePerSqmValue = area.avg_price_per_sqm;
                    
                    // If avg_price_per_sqm is missing but market_share_percentage has a large value (>1000), use that
                    if (!pricePerSqmValue && area.market_share_percentage && area.market_share_percentage > 1000) {
                        console.log('🔧 USING market_share_percentage as price_per_sqm');
                        pricePerSqmValue = area.market_share_percentage;
                    }
                    
                    const formattedPricePerSqm = (pricePerSqmValue && typeof pricePerSqmValue === 'number' && pricePerSqmValue > 0) 
                        ? new Intl.NumberFormat('en-AE', {
                            style: 'currency',
                            currency: 'AED',
                            maximumFractionDigits: 0
                        }).format(Math.round(pricePerSqmValue))
                        : 'N/A';
                    
                    console.log('🔍 formattedPricePerSqm result:', formattedPricePerSqm);
                    
                    const priceLabel = searchType === 'buy' ? 'Avg Sale Price' : 'Avg Annual Rent';
                    const pricePerSqmLabel = searchType === 'buy' ? 'Price/Sq.M' : 'Rent/Sq.M';
                    
                    rankingItem.innerHTML = `
                        <div class="ranking-info">
                            <div class="rank-number">${index + 1}</div>
                            <div class="area-details">
                                <h5>${area.area_name}</h5>
                                <div class="area-metrics">
                                    <span class="transaction-count">${area.transaction_count.toLocaleString()} transactions</span> 
                                    | ${priceLabel}: ${formattedPrice}
                                    | ${pricePerSqmLabel}: ${formattedPricePerSqm}
                                    | Market Share: ${area.market_share_percentage}%
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(rankingItem);
                });
            }

            function showTopAreasError(message) {
                const container = document.getElementById('top-areas-list');
                container.innerHTML = `<p style="color: #dc3545; text-align: center; padding: 20px;">${message}</p>`;
            }

            // Enhanced Metrics Tooltip Functionality
            document.addEventListener('DOMContentLoaded', function() {
                const tooltipElements = document.querySelectorAll('.metric-tooltip');
                
                tooltipElements.forEach(element => {
                    // Double-click event for mobile and desktop
                    element.addEventListener('dblclick', function(e) {
                        e.preventDefault();
                        
                        // Remove active class from all other tooltips
                        tooltipElements.forEach(el => {
                            if (el !== element) {
                                el.classList.remove('tooltip-active');
                            }
                        });
                        
                        // Toggle active class on current element
                        element.classList.toggle('tooltip-active');
                        
                        // Auto-hide after 5 seconds
                        if (element.classList.contains('tooltip-active')) {
                            setTimeout(() => {
                                element.classList.remove('tooltip-active');
                            }, 5000);
                        }
                    });
                    
                    // Click outside to close tooltips
                    document.addEventListener('click', function(e) {
                        if (!element.contains(e.target)) {
                            element.classList.remove('tooltip-active');
                        }
                    });
                    
                    // Touch events for better mobile experience
                    element.addEventListener('touchstart', function(e) {
                        // Clear any existing timeout
                        if (element.touchTimeout) {
                            clearTimeout(element.touchTimeout);
                        }
                        
                        // Set a timeout to detect double tap
                        element.touchTimeout = setTimeout(() => {
                            element.touchTimeout = null;
                        }, 300);
                    });
                    
                    element.addEventListener('touchend', function(e) {
                        if (element.touchTimeout) {
                            // This is a double tap
                            clearTimeout(element.touchTimeout);
                            element.touchTimeout = null;
                            
                            e.preventDefault();
                            
                            // Remove active class from all other tooltips
                            tooltipElements.forEach(el => {
                                if (el !== element) {
                                    el.classList.remove('tooltip-active');
                                }
                            });
                            
                            // Toggle active class on current element
                            element.classList.toggle('tooltip-active');
                            
                            // Auto-hide after 5 seconds
                            if (element.classList.contains('tooltip-active')) {
                                setTimeout(() => {
                                    element.classList.remove('tooltip-active');
                                }, 5000);
                            }
                        }
                    });
                });
            });

            // Property Valuation Functionality
            async function submitValuation(event) {
                event.preventDefault();
                
                const propertyType = document.getElementById('valuation-property-type').value;
                const area = document.getElementById('valuation-area').value.trim();
                const size = parseFloat(document.getElementById('valuation-size').value);
                const bedrooms = document.getElementById('valuation-bedrooms').value;
                const status = document.getElementById('valuation-status').value;
                
                // PHASE 3: Get optional advanced fields
                const floorLevel = document.getElementById('floor-level').value;
                const viewType = document.getElementById('view-type').value;
                const propertyAge = document.getElementById('property-age').value;
                const esgScoreMin = document.getElementById('esg-score-min').value;
                const flipScoreMin = document.getElementById('flip-score-min').value;
                const arbitrageScoreMin = document.getElementById('arbitrage-score-min').value;
                
                // Validation
                if (!propertyType || !area || !size || size <= 0) {
                    alert('Please fill in all fields with valid values.');
                    return;
                }
                
                // Show loading state
                document.getElementById('valuation-loading').style.display = 'block';
                document.getElementById('valuation-results').style.display = 'none';
                
                try {
                    const requestData = {
                        property_type: propertyType,
                        area: area,
                        size_sqm: size
                    };
                    
                    // Add bedrooms only if selected (not empty)
                    if (bedrooms) {
                        requestData.bedrooms = bedrooms;
                    }
                    
                    // Add development status only if selected (not empty)
                    if (status) {
                        requestData.development_status = status;
                    }
                    
                    // PHASE 3: Add optional advanced fields
                    if (floorLevel && floorLevel !== '') {
                        requestData.floor_level = parseInt(floorLevel);
                    }
                    
                    if (viewType && viewType !== '') {
                        requestData.view_type = viewType;
                    }
                    
                    if (propertyAge && propertyAge !== '') {
                        requestData.property_age = parseInt(propertyAge);
                    }
                    
                    // Add ESG score filter if selected
                    if (esgScoreMin && esgScoreMin !== '') {
                        requestData.esg_score_min = parseInt(esgScoreMin);
                    }
                    
                    // Add Flip score filter if selected
                    if (flipScoreMin && flipScoreMin !== '') {
                        requestData.flip_score_min = parseInt(flipScoreMin);
                    }
                    
                    // Add Arbitrage score filter if selected
                    if (arbitrageScoreMin && arbitrageScoreMin !== '') {
                        requestData.arbitrage_score_min = parseInt(arbitrageScoreMin);
                    }
                    
                    const response = await fetch('/api/property/valuation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    displayValuationResults(data, propertyType, area, size, bedrooms);
                    
                } catch (error) {
                    console.error('Valuation error:', error);
                    document.getElementById('valuation-loading').style.display = 'none';
                    alert(`Error getting valuation: ${error.message}`);
                }
            }
            
            function displayValuationResults(data, propertyType, area, size, bedrooms) {
                // Hide loading
                document.getElementById('valuation-loading').style.display = 'none';
                
                // Check if we have a successful response with valuation data
                if (!data.success || !data.valuation) {
                    alert(`Valuation failed: ${data.error || 'Unknown error'}`);
                    return;
                }
                
                const valuation = data.valuation;
                
                // Format numbers
                const formatAED = (amount) => new Intl.NumberFormat('en-AE', {
                    style: 'currency',
                    currency: 'AED',
                    maximumFractionDigits: 0
                }).format(amount);
                
                // Update results with proper data structure
                document.getElementById('estimated-value').textContent = 
                    new Intl.NumberFormat('en-AE').format(valuation.estimated_value);
                document.getElementById('confidence-score').textContent = `${valuation.confidence_score}%`;
                document.getElementById('price-per-sqm').textContent = 
                    new Intl.NumberFormat('en-AE').format(valuation.price_per_sqm);
                
                // Update segment badge if available (both locations)
                if (valuation.segment) {
                    const topPercentage = 100 - valuation.segment.percentile;
                    // Changed from "Top X%" to tier-based label to avoid misleading language with fixed thresholds
                    const badgeText = `${valuation.segment.icon} ${valuation.segment.label} Tier`;
                    const badgeTitle = valuation.segment.description + ' (' + valuation.segment.range + ') - Top ' + topPercentage + '% (Historic 2025 Data)';
                    
                    // Set gradient color based on segment
                    const gradients = {
                        'budget': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'mid': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        'premium': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        'luxury': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                        'ultra': 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'
                    };
                    const badgeGradient = gradients[valuation.segment.segment] || gradients['mid'];
                    
                    // Update both badge locations (KPI cards and valuation details)
                    ['segment-badge', 'segment-badge-details'].forEach(badgeId => {
                        const badge = document.getElementById(badgeId);
                        if (badge) {
                            badge.textContent = badgeText;
                            badge.style.background = badgeGradient;
                            badge.style.display = 'block';
                            badge.title = badgeTitle;
                        }
                    });
                } else {
                    // Hide both badges if no segment data
                    ['segment-badge', 'segment-badge-details'].forEach(badgeId => {
                        const badge = document.getElementById(badgeId);
                        if (badge) badge.style.display = 'none';
                    });
                }
                
                document.getElementById('value-range-min').textContent = 
                    new Intl.NumberFormat('en-AE').format(valuation.value_range.low);
                document.getElementById('value-range-max').textContent = 
                    new Intl.NumberFormat('en-AE').format(valuation.value_range.high);
                document.getElementById('comparables-count').textContent = valuation.total_comparables_found || 0;
                document.getElementById('valuation-timestamp').textContent = 
                    new Date().toLocaleString('en-AE', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                
                // Store valuation data for PDF export
                lastValuationData = data.valuation;
                
                // Calculate and display rental yield (NEW)
                if (valuation.rental_data && valuation.rental_data.annual_rent && valuation.estimated_value > 0) {
                    const grossYield = (valuation.rental_data.annual_rent / valuation.estimated_value * 100).toFixed(2);
                    
                    // Show rental yield card with multiple visibility settings
                    const rentalCard = document.getElementById('rental-yield-card');
                    if (rentalCard) {
                        rentalCard.style.display = 'block';
                        rentalCard.style.visibility = 'visible';
                        rentalCard.style.opacity = '1';
                        rentalCard.classList.remove('d-none'); // Remove bootstrap hidden class if present
                        console.log('✅ Rental yield card visibility set to: block');
                    } else {
                        console.error('❌ rental-yield-card element not found in DOM!');
                    }
                    
                    const yieldTextElement = document.getElementById('rental-yield');
                    if (yieldTextElement) {
                        yieldTextElement.textContent = grossYield;
                        console.log(`✅ Rental yield text updated: ${grossYield}%`);
                    } else {
                        console.error('❌ rental-yield element not found in DOM!');
                    }
                    
                    // Update subtitle based on data quality
                    let subtitle = `Based on ${valuation.rental_data.count} rental comparables`;
                    if (valuation.rental_data.is_city_average) {
                        subtitle = `City-wide average (${valuation.rental_data.count} rentals)`;
                    }
                    document.getElementById('rental-subtitle').textContent = subtitle;
                    
                    // Color code based on yield quality
                    const yieldElement = document.getElementById('rental-yield');
                    const yieldValue = parseFloat(grossYield);
                    if (yieldValue >= 6.0) {
                        yieldElement.style.color = '#4CAF50'; // Green - excellent yield
                    } else if (yieldValue >= 4.0) {
                        yieldElement.style.color = '#FF9800'; // Orange - average yield
                    } else {
                        yieldElement.style.color = '#F44336'; // Red - low yield
                    }
                    
                    console.log(`💰 Rental Yield: ${grossYield}% (Annual Rent: ${valuation.rental_data.annual_rent.toLocaleString()} AED/year)`);
                } else {
                    // Hide rental yield card if no data available
                    document.getElementById('rental-yield-card').style.display = 'none';
                    console.log('⚠️ Rental data not available for this property');
                }
                
                // Calculate and display Property Flip Score (NEW - Quick Win Feature)
                calculateFlipScore(propertyType, area, size, bedrooms);
                
                // Calculate and display Property Arbitrage Score (NEW - Investment Opportunity Detection)
                const estimatedValue = valuation.estimated_value;
                calculateArbitrageScore(propertyType, area, size, bedrooms, estimatedValue);
                
                // Display ML Hybrid Valuation (PHASE 4 - NEW)
                if (valuation.ml_data && valuation.ml_data.ml_enabled) {
                    const mlData = valuation.ml_data;
                    const mlCard = document.getElementById('ml-hybrid-card');
                    
                    // Show the card
                    mlCard.style.display = 'block';
                    
                    // Display method badge
                    const methodBadge = document.getElementById('ml-method-badge');
                    if (mlData.valuation_method === 'hybrid') {
                        methodBadge.textContent = '🤖 Hybrid (ML + Rules)';
                        methodBadge.style.background = '#f3e5f5';
                        methodBadge.style.color = '#6a1b9a';
                    } else if (mlData.valuation_method === 'ml_only') {
                        methodBadge.textContent = '🤖 ML Only';
                        methodBadge.style.background = '#e1bee7';
                        methodBadge.style.color = '#4a148c';
                    } else {
                        methodBadge.textContent = '📊 Rule-Based Only';
                        methodBadge.style.background = '#e0e0e0';
                        methodBadge.style.color = '#424242';
                    }
                    
                    // Populate breakdown
                    const formatPrice = (price) => price ? new Intl.NumberFormat('en-AE').format(price) + ' AED' : 'N/A';
                    
                    document.getElementById('ml-price').textContent = formatPrice(mlData.ml_price);
                    document.getElementById('rule-based-price').textContent = formatPrice(mlData.rule_based_price);
                    document.getElementById('ml-confidence').textContent = mlData.ml_confidence ? `${mlData.ml_confidence}%` : 'N/A';
                    document.getElementById('ml-final-price').textContent = formatPrice(mlData.final_price);
                    
                    console.log(`🤖 ML Valuation: ${mlData.valuation_method}`);
                    console.log(`   ML Price: ${mlData.ml_price ? mlData.ml_price.toLocaleString() : 'N/A'} AED`);
                    console.log(`   Rule-Based: ${mlData.rule_based_price.toLocaleString()} AED`);
                    console.log(`   Final: ${mlData.final_price.toLocaleString()} AED`);
                } else {
                    // Hide ML card if not enabled
                    document.getElementById('ml-hybrid-card').style.display = 'none';
                }
                
                // Display location premium (NEW - Geospatial)
                if (valuation.location_premium && valuation.location_premium.applied) {
                    const premium = valuation.location_premium;
                    const premiumCard = document.getElementById('location-premium-card');
                    
                    // Show the card
                    premiumCard.style.display = 'block';
                    
                    // Format and display total premium
                    const premiumPct = premium.total_premium_pct || 0;
                    const sign = premiumPct > 0 ? '+' : '';
                    const color = premiumPct > 0 ? '#4CAF50' : (premiumPct < 0 ? '#F44336' : '#666');
                    
                    document.getElementById('location-premium-pct').textContent = `${sign}${premiumPct.toFixed(2)}`;
                    document.getElementById('location-premium-pct').style.color = color;
                    
                    // Display cache status badge
                    const cacheBadge = document.getElementById('location-cache-badge');
                    cacheBadge.textContent = premium.cache_status || 'UNKNOWN';
                    
                    // Color code cache badge
                    if (premium.cache_status === 'HIT') {
                        cacheBadge.style.background = '#d4edda';
                        cacheBadge.style.color = '#155724';
                    } else if (premium.cache_status === 'MISS') {
                        cacheBadge.style.background = '#fff3cd';
                        cacheBadge.style.color = '#856404';
                    } else {
                        cacheBadge.style.background = '#e2e3e5';
                        cacheBadge.style.color = '#383d41';
                    }
                    
                    // Display breakdown (if available)
                    if (premium.breakdown) {
                        const bd = premium.breakdown;
                        document.getElementById('premium-metro').textContent = `${bd.metro > 0 ? '+' : ''}${bd.metro.toFixed(2)}%`;
                        document.getElementById('premium-beach').textContent = `${bd.beach > 0 ? '+' : ''}${bd.beach.toFixed(2)}%`;
                        document.getElementById('premium-mall').textContent = `${bd.mall > 0 ? '+' : ''}${bd.mall.toFixed(2)}%`;
                        document.getElementById('premium-school').textContent = `${bd.school > 0 ? '+' : ''}${bd.school.toFixed(2)}%`;
                        document.getElementById('premium-business').textContent = `${bd.business > 0 ? '+' : ''}${bd.business.toFixed(2)}%`;
                        document.getElementById('premium-neighborhood').textContent = `${bd.neighborhood > 0 ? '+' : ''}${bd.neighborhood.toFixed(2)}%`;
                    }
                    
                    console.log(`🌍 Location Premium: ${sign}${premiumPct.toFixed(2)}% (${premium.cache_status})`);
                } else {
                    // Hide location premium card if not applied
                    document.getElementById('location-premium-card').style.display = 'none';
                }
                
                // Display project premium (NEW - Luxury Projects)
                if (valuation.project_premium && valuation.project_premium.applied) {
                    const projectPremium = valuation.project_premium;
                    const projectCard = document.getElementById('project-premium-card');
                    
                    // Show the card
                    projectCard.style.display = 'block';
                    
                    // Display project name
                    document.getElementById('project-premium-name').textContent = projectPremium.project_name || 'Unknown Project';
                    
                    // Display premium percentage
                    const premiumPct = projectPremium.premium_pct || 0;
                    document.getElementById('project-premium-pct').textContent = premiumPct.toFixed(2);
                    
                    // Display tier badge
                    const tierBadge = document.getElementById('project-tier-badge');
                    const tier = projectPremium.tier || 'Standard';
                    tierBadge.textContent = tier;
                    
                    // Color code tier badge
                    if (tier === 'Ultra-Luxury') {
                        tierBadge.style.background = '#ffc107';
                        tierBadge.style.color = '#000';
                        tierBadge.style.fontWeight = 'bold';
                    } else if (tier === 'Super-Premium') {
                        tierBadge.style.background = '#ff9800';
                        tierBadge.style.color = '#000';
                    } else if (tier === 'Premium') {
                        tierBadge.style.background = '#fff3cd';
                        tierBadge.style.color = '#856404';
                    } else {
                        tierBadge.style.background = '#e2e3e5';
                        tierBadge.style.color = '#383d41';
                    }
                    
                    // Display combined premium
                    const combinedPct = valuation.combined_premium || 0;
                    document.getElementById('combined-premium-pct').textContent = combinedPct.toFixed(2);
                    
                    console.log(`🏢 Project Premium: +${premiumPct.toFixed(2)}% (${tier}) - ${projectPremium.project_name}`);
                    console.log(`🎯 Combined Premium: +${combinedPct.toFixed(2)}% (Location + Project)`);
                    
                    // Display trend badge (NEW - Phase 2 Quick Win)
                    const trendBadge = document.getElementById('premium-trend-badge');
                    if (trendBadge) {
                        // Demo values (hardcoded for now - will connect to price_history in Phase 3)
                        const demoTrends = {
                            'City Walk Crestlane 2': { last: 8.0, trend: 'up' },
                            'City Walk Crestlane 3': { last: 10.0, trend: 'stable' },
                            'Trump Tower': { last: 17.0, trend: 'down' },
                            'ROVE HOME': { last: 14.0, trend: 'up' },
                            'Ciel': { last: 20.0, trend: 'stable' }
                        };
                        
                        const projectData = demoTrends[projectPremium.project_name];
                        
                        if (projectData) {
                            const lastPremium = projectData.last;
                            const currentPremium = premiumPct;
                            
                            if (currentPremium > lastPremium) {
                                trendBadge.innerHTML = `↑ Up from ${lastPremium}%`;
                                trendBadge.style.background = '#d4edda';
                                trendBadge.style.color = '#155724';
                                trendBadge.style.display = 'inline-block';
                            } else if (currentPremium < lastPremium) {
                                trendBadge.innerHTML = `↓ Down from ${lastPremium}%`;
                                trendBadge.style.background = '#f8d7da';
                                trendBadge.style.color = '#721c24';
                                trendBadge.style.display = 'inline-block';
                            } else {
                                trendBadge.innerHTML = '→ Stable';
                                trendBadge.style.background = '#e2e3e5';
                                trendBadge.style.color = '#383d41';
                                trendBadge.style.display = 'inline-block';
                            }
                            trendBadge.title = 'Compared to previous valuation (demo data)';
                        } else {
                            // Hide badge if no historical data
                            trendBadge.style.display = 'none';
                        }
                    }
                    
                    // ===== TOOLTIP & MODAL INTERACTIONS (NEW - UX Enhancement) =====
                    
                    // Store data for tooltip and modal
                    window.currentProjectPremium = projectPremium;
                    window.currentValuation = valuation;
                    
                    // Setup info icon tooltip
                    const infoIcon = document.getElementById('project-info-icon');
                    const tooltip = document.getElementById('project-tooltip');
                    
                    if (infoIcon && tooltip) {
                        // Show tooltip on click
                        infoIcon.addEventListener('click', function(e) {
                            e.stopPropagation();
                            
                            // Populate tooltip
                            document.getElementById('tooltip-project-name').textContent = projectPremium.project_name;
                            document.getElementById('tooltip-premium-pct').textContent = premiumPct.toFixed(2);
                            document.getElementById('tooltip-transaction-count').textContent = valuation.total_comparables_found || 0;
                            
                            // Populate breakdown
                            const breakdownDiv = document.getElementById('tooltip-breakdown');
                            breakdownDiv.innerHTML = '';
                            
                            if (projectPremium.breakdown && projectPremium.breakdown.length > 0) {
                                projectPremium.breakdown.forEach(item => {
                                    const itemDiv = document.createElement('div');
                                    itemDiv.style.cssText = 'display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #eee;';
                                    itemDiv.innerHTML = `
                                        <span style="color:#666; font-size:13px;">${item.factor}</span>
                                        <span style="color:#ffc107; font-weight:bold; font-size:13px;">+${item.percentage}%</span>
                                    `;
                                    breakdownDiv.appendChild(itemDiv);
                                });
                            } else {
                                breakdownDiv.innerHTML = '<div style="color:#999; font-style:italic;">No breakdown available</div>';
                            }
                            
                            // Position tooltip near info icon (accounting for page scroll)
                            const iconRect = infoIcon.getBoundingClientRect();
                            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
                            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
                            
                            // Position below the icon by default
                            tooltip.style.left = (iconRect.left + scrollX) + 'px';
                            tooltip.style.top = (iconRect.bottom + scrollY + 5) + 'px';
                            
                            // Show tooltip
                            tooltip.style.display = 'block';
                            
                            // Adjust if tooltip goes off screen
                            setTimeout(() => {
                                const tooltipRect = tooltip.getBoundingClientRect();
                                
                                // If goes off right edge, align to right side of icon
                                if (tooltipRect.right > window.innerWidth) {
                                    tooltip.style.left = (iconRect.right + scrollX - tooltipRect.width) + 'px';
                                }
                                
                                // If goes off bottom edge, position above icon instead
                                if (tooltipRect.bottom > window.innerHeight + scrollY) {
                                    tooltip.style.top = (iconRect.top + scrollY - tooltipRect.height - 5) + 'px';
                                }
                            }, 10);
                        });
                        
                        // Hide tooltip when clicking outside
                        document.addEventListener('click', function(e) {
                            if (!tooltip.contains(e.target) && e.target !== infoIcon) {
                                tooltip.style.display = 'none';
                            }
                        });
                    }
                    
                    // Setup "View Full Breakdown" modal
                    const viewBreakdownLink = document.getElementById('view-project-breakdown');
                    const modal = document.getElementById('project-premium-modal');
                    const closeBtn1 = document.getElementById('close-modal-btn');
                    const closeBtn2 = document.getElementById('close-modal-btn-2');
                    
                    if (viewBreakdownLink && modal) {
                        // Remove old event listener if exists (prevent duplicates)
                        const oldHandler = viewBreakdownLink.onclick;
                        viewBreakdownLink.onclick = null;
                        
                        // Open modal on click
                        viewBreakdownLink.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            console.log('🔍 Opening project premium modal...');
                            
                            // Populate modal header
                            document.getElementById('modal-project-name').textContent = projectPremium.project_name;
                            document.getElementById('modal-premium-pct').textContent = premiumPct.toFixed(2);
                            document.getElementById('modal-tier').textContent = projectPremium.tier || 'Premium';
                            
                            // Populate breakdown items
                            const breakdownItems = document.getElementById('modal-breakdown-items');
                            breakdownItems.innerHTML = '';
                            
                            if (projectPremium.breakdown && projectPremium.breakdown.length > 0) {
                                projectPremium.breakdown.forEach(item => {
                                    const itemDiv = document.createElement('div');
                                    itemDiv.style.cssText = 'background:#f8f9fa; border-left:4px solid #ffc107; padding:15px; margin-bottom:12px; border-radius:6px;';
                                    itemDiv.innerHTML = `
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                            <span style="font-weight:bold; color:#333; font-size:15px;">${item.factor}</span>
                                            <span style="background:#ffc107; color:#000; padding:4px 12px; border-radius:20px; font-weight:bold; font-size:14px;">+${item.percentage}%</span>
                                        </div>
                                        <p style="color:#666; font-size:13px; margin:0; line-height:1.6;">${item.description}</p>
                                    `;
                                    breakdownItems.appendChild(itemDiv);
                                });
                            } else {
                                breakdownItems.innerHTML = '<div style="color:#999; padding:20px; text-align:center; font-style:italic;">No detailed breakdown available</div>';
                            }
                            
                            // Populate market validation stats
                            document.getElementById('modal-transaction-count').textContent = valuation.total_comparables_found || 0;
                            document.getElementById('modal-avg-price').textContent = new Intl.NumberFormat('en-AE').format(valuation.price_per_sqm || 0) + ' AED/sqm';
                            document.getElementById('modal-tier').textContent = projectPremium.tier || 'Premium';
                            
                            // Populate value impact
                            const locationPremium = valuation.location_premium?.total_premium || 0;
                            const combinedPremium = valuation.combined_premium || 0;
                            
                            document.getElementById('modal-location-premium').textContent = locationPremium.toFixed(2);
                            document.getElementById('modal-project-premium').textContent = premiumPct.toFixed(2);
                            document.getElementById('modal-combined-premium').textContent = combinedPremium.toFixed(2);
                            
                            // Populate similar projects (NEW - Phase 2)
                            const similarContainer = document.getElementById('similar-projects-container');
                            const similarProjects = projectPremium.similar_projects || [];
                            
                            if (similarProjects.length > 0) {
                                let tableHTML = `
                                    <table style="width:100%; border-collapse:collapse; background:white;">
                                        <thead>
                                            <tr style="background:#ffc107; color:#000;">
                                                <th style="padding:10px; text-align:left; font-size:0.9rem;">Project Name</th>
                                                <th style="padding:10px; text-align:center; font-size:0.9rem;">Tier</th>
                                                <th style="padding:10px; text-align:center; font-size:0.9rem;">Premium</th>
                                                <th style="padding:10px; text-align:center; font-size:0.9rem;">Transactions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                `;
                                
                                similarProjects.forEach((proj, idx) => {
                                    const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
                                    tableHTML += `
                                        <tr style="background:${bgColor};">
                                            <td style="padding:10px; border-bottom:1px solid #dee2e6; font-size:0.85rem;">${proj.name}</td>
                                            <td style="padding:10px; border-bottom:1px solid #dee2e6; text-align:center; font-size:0.85rem;">
                                                <span style="background:#fff3cd; color:#856404; padding:2px 8px; border-radius:4px; font-size:0.75rem;">
                                                    ${proj.tier}
                                                </span>
                                            </td>
                                            <td style="padding:10px; border-bottom:1px solid #dee2e6; text-align:center; font-weight:bold; color:#ffc107; font-size:0.85rem;">
                                                +${proj.premium}%
                                            </td>
                                            <td style="padding:10px; border-bottom:1px solid #dee2e6; text-align:center; color:#666; font-size:0.85rem;">
                                                ${proj.transactions}
                                            </td>
                                        </tr>
                                    `;
                                });
                                
                                tableHTML += `
                                        </tbody>
                                    </table>
                                    <p style="font-size:0.75rem; color:#999; margin-top:10px; text-align:center;">
                                        Showing ${similarProjects.length} similar ${projectPremium.tier} projects
                                    </p>
                                `;
                                
                                similarContainer.innerHTML = tableHTML;
                            } else {
                                similarContainer.innerHTML = `
                                    <div style="text-align:center; padding:20px; color:#999;">
                                        <span style="font-size:2rem;">🏆</span>
                                        <p style="margin:10px 0 0 0; font-size:0.9rem;">No similar projects found</p>
                                        <p style="margin:5px 0 0 0; font-size:0.8rem; color:#ccc;">This project is unique in its tier</p>
                                    </div>
                                `;
                            }
                            
                            // Show modal with fade-in animation
                            modal.style.display = 'flex';
                            const modalContainer = modal.querySelector('div');
                            setTimeout(() => {
                                modal.style.opacity = '1';
                                if (modalContainer) modalContainer.style.transform = 'translateY(0)';
                            }, 10);
                            
                            console.log('✅ Modal opened successfully');
                        };
                        
                        // Close modal handlers
                        function closeModal() {
                            const modalContainer = modal.querySelector('div');
                            modal.style.opacity = '0';
                            if (modalContainer) modalContainer.style.transform = 'translateY(-20px)';
                            setTimeout(() => {
                                modal.style.display = 'none';
                            }, 300);
                            console.log('✅ Modal closed');
                        }
                        
                        if (closeBtn1) {
                            closeBtn1.onclick = function(e) {
                                e.preventDefault();
                                closeModal();
                            };
                        }
                        if (closeBtn2) {
                            closeBtn2.onclick = function(e) {
                                e.preventDefault();
                                closeModal();
                            };
                        }
                        
                        // Close on backdrop click
                        modal.onclick = function(e) {
                            if (e.target === modal) {
                                closeModal();
                            }
                        };
                        
                        // Close on Escape key (set up once, not repeatedly)
                        if (!window.modalEscapeHandlerSet) {
                            document.addEventListener('keydown', function(e) {
                                if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
                                    closeModal();
                                }
                            });
                            window.modalEscapeHandlerSet = true;
                        }
                        
                        // CSV Download Handler (NEW - Phase 2)
                        const downloadCsvBtn = document.getElementById('download-csv-btn');
                        if (downloadCsvBtn) {
                            downloadCsvBtn.onclick = function(e) {
                                e.preventDefault();
                                
                                console.log('📥 Downloading CSV...');
                                
                                // Prepare data for export
                                const exportData = {
                                    project_name: projectPremium.project_name,
                                    tier: projectPremium.tier,
                                    premium_pct: premiumPct,
                                    breakdown: projectPremium.breakdown || []
                                };
                                
                                // Send POST request to generate CSV
                                fetch('/api/export-premium-csv', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(exportData)
                                })
                                .then(response => {
                                    if (!response.ok) throw new Error('Export failed');
                                    return response.blob();
                                })
                                .then(blob => {
                                    // Create download link
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `premium-breakdown-${projectPremium.project_name.replace(/ /g, '-').toLowerCase()}.csv`;
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(url);
                                    
                                    console.log('✅ CSV downloaded successfully');
                                })
                                .catch(error => {
                                    console.error('❌ CSV download error:', error);
                                    alert('Failed to download CSV. Please try again.');
                                });
                            };
                        }
                    }
                    
                } else {
                    // Hide project premium card if not applied
                    document.getElementById('project-premium-card').style.display = 'none';
                }
                
                // PHASE 3: Display Floor Premium
                if (valuation.floor_premium && valuation.floor_premium.applicable) {
                    const floorPremium = valuation.floor_premium;
                    const floorCard = document.getElementById('floor-premium-card');
                    
                    floorCard.style.display = 'block';
                    document.getElementById('floor-number').textContent = floorPremium.floor_level;
                    document.getElementById('floor-premium-pct').textContent = floorPremium.percentage.toFixed(1);
                    
                    console.log(`🏢 Floor Premium: +${floorPremium.percentage.toFixed(1)}% (Floor ${floorPremium.floor_level})`);
                } else {
                    document.getElementById('floor-premium-card').style.display = 'none';
                }
                
                // PHASE 3: Display View Premium
                if (valuation.view_premium && valuation.view_premium.applicable) {
                    const viewPremium = valuation.view_premium;
                    const viewCard = document.getElementById('view-premium-card');
                    
                    viewCard.style.display = 'block';
                    document.getElementById('view-type-display').textContent = viewPremium.view_type;
                    document.getElementById('view-premium-pct').textContent = viewPremium.percentage.toFixed(1);
                    
                    console.log(`👁️ View Premium: +${viewPremium.percentage.toFixed(1)}% (${viewPremium.view_type})`);
                } else {
                    document.getElementById('view-premium-card').style.display = 'none';
                }
                
                // PHASE 3: Display Age Premium/Depreciation
                if (valuation.age_premium && valuation.age_premium.applicable) {
                    const agePremium = valuation.age_premium;
                    const ageCard = document.getElementById('age-premium-card');
                    
                    ageCard.style.display = 'block';
                    document.getElementById('age-display').textContent = agePremium.property_age;
                    
                    const agePct = agePremium.percentage;
                    const agePctElement = document.getElementById('age-premium-pct');
                    const ageValueElement = document.getElementById('age-premium-value');
                    const ageTitleElement = document.getElementById('age-card-title');
                    const ageDescElement = document.getElementById('age-description');
                    
                    if (agePct >= 0) {
                        // Positive premium (new property)
                        agePctElement.textContent = '+' + agePct.toFixed(1);
                        ageValueElement.style.color = '#4CAF50';
                        ageCard.style.borderLeftColor = '#4CAF50';
                        ageTitleElement.innerHTML = '⭐ New Property Bonus';
                        ageDescElement.textContent = 'Premium for newer property';
                        console.log(`⭐ Age Bonus: +${agePct.toFixed(1)}% (${agePremium.property_age} years old)`);
                    } else {
                        // Negative premium (depreciation)
                        agePctElement.textContent = agePct.toFixed(1);
                        ageValueElement.style.color = '#F44336';
                        ageCard.style.borderLeftColor = '#F44336';
                        ageTitleElement.innerHTML = '📉 Property Depreciation';
                        ageDescElement.textContent = 'Age-related value adjustment';
                        console.log(`📉 Age Depreciation: ${agePct.toFixed(1)}% (${agePremium.property_age} years old)`);
                    }
                } else {
                    document.getElementById('age-premium-card').style.display = 'none';
                }
                
                // Update combined premium display with Phase 3
                const combinedPct = valuation.combined_premium || 0;
                const combinedElement = document.getElementById('combined-premium-pct');
                if (combinedElement) {
                    combinedElement.textContent = combinedPct.toFixed(2);
                    
                    // Update the text description
                    const descElement = combinedElement.closest('div').querySelector('p:last-of-type');
                    if (descElement) {
                        let premiumParts = [];
                        if (valuation.location_premium && valuation.location_premium.applied) premiumParts.push('Location');
                        if (valuation.project_premium && valuation.project_premium.applied) premiumParts.push('Project');
                        if (valuation.floor_premium && valuation.floor_premium.applicable) premiumParts.push('Floor');
                        if (valuation.view_premium && valuation.view_premium.applicable) premiumParts.push('View');
                        if (valuation.age_premium && valuation.age_premium.applicable) premiumParts.push('Age');
                        
                        if (premiumParts.length > 0) {
                            descElement.textContent = premiumParts.join(' + ');
                        }
                    }
                }
                
                // Show results
                document.getElementById('valuation-results').style.display = 'block';
                
                // Render comparable properties section (SALES - shown first as it's used for valuation)
                const comparables = valuation.comparables || valuation.comparable_properties || [];
                lastComparablesData = comparables;
                renderComparableProperties(comparables);
                
                // Render rental comparables section (RENTALS - shown second as yield depends on valuation)
                if (valuation.rental_data && valuation.rental_data.comparables) {
                    renderRentalComparables(valuation.rental_data);
                }
            }
            
            function renderRentalComparables(rentalData) {
                /**
                 * Render rental comparable properties table in the valuation report.
                 * @param {Object} rentalData - Rental data object with comparables array
                 */
                const existingSection = document.getElementById('rental-comparables-section');
                if (existingSection) {
                    existingSection.remove();
                }

                const resultsDiv = document.getElementById('valuation-results');
                if (!resultsDiv) return;

                const comparables = rentalData.comparables || [];
                
                const sectionHtml = `
                    <div id="rental-comparables-section" class="rental-comparables-section">
                        <h3 style="color: #667eea; margin: 20px 0 15px 0;">🏢 Rental Properties Used for Yield Calculation</h3>
                        ${comparables.length === 0 
                            ? '<p style="color: #666; font-style: italic;">No rental comparables available for this property.</p>'
                            : `<div class="table-responsive">
                                <table class="rental-comparables-table">
                                    <thead>
                                        <tr>
                                            <th>Location</th>
                                            <th>Size (sqm)</th>
                                            <th>Annual Rent (AED)</th>
                                            <th>Rent per sqm</th>
                                            <th>Listing Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${comparables.slice(0, 50).map(rental => {
                                            const listingDate = rental.listing_date ? 
                                                (rental.listing_date !== 'None' && rental.listing_date.trim() !== '' ? 
                                                    new Date(rental.listing_date).toLocaleDateString('en-GB') : 'N/A') 
                                                : 'N/A';
                                            
                                            return `<tr>
                                                <td title="${rental.location || 'N/A'}">${rental.location ? (rental.location.length > 25 ? rental.location.substring(0, 25) + '...' : rental.location) : 'N/A'}</td>
                                                <td>${rental.size_sqm ? rental.size_sqm.toFixed(1) : 'N/A'}</td>
                                                <td>${rental.annual_rent ? new Intl.NumberFormat('en-AE').format(rental.annual_rent) : 'N/A'}</td>
                                                <td>${rental.rent_per_sqm ? new Intl.NumberFormat('en-AE').format(rental.rent_per_sqm) : 'N/A'}</td>
                                                <td>${listingDate}</td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                                ${comparables.length > 50 
                                    ? `<p style="color: #666; margin-top: 10px; font-size: 0.9em;">Showing first 50 of ${comparables.length} rental properties</p>`
                                    : ''}
                               </div>
                               
                               <!-- Summary Statistics -->
                               <div class="rental-stats-summary">
                                   <div class="stat">
                                       <div class="stat-label">Median Annual Rent</div>
                                       <div class="stat-value">${rentalData.annual_rent ? new Intl.NumberFormat('en-AE').format(rentalData.annual_rent) : 'N/A'} AED</div>
                                   </div>
                                   <div class="stat">
                                       <div class="stat-label">Rent Range</div>
                                       <div class="stat-value">${rentalData.price_range ? new Intl.NumberFormat('en-AE').format(rentalData.price_range.low) + ' - ' + new Intl.NumberFormat('en-AE').format(rentalData.price_range.high) : 'N/A'}</div>
                                   </div>
                                   <div class="stat">
                                       <div class="stat-label">Average Size</div>
                                       <div class="stat-value">${rentalData.median_size ? rentalData.median_size.toFixed(0) : 'N/A'} sqm</div>
                                   </div>
                                   <div class="stat">
                                       <div class="stat-label">Properties Analyzed</div>
                                       <div class="stat-value">${rentalData.count || 0}</div>
                                   </div>
                               </div>
                               
                               ${rentalData.is_city_average 
                                   ? '<p class="data-source-note" style="color: #FF9800; background: #FFF3E0; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 13px;">⚠️ <strong>Note:</strong> Using city-wide data due to insufficient area-specific rentals. Consider verifying with local market research for more accurate yield estimation.</p>'
                                   : '<p class="data-source-note" style="color: #4CAF50; background: #E8F5E9; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 13px;">✅ <strong>Data source:</strong> Area-specific rental comparables with similar property sizes (±30% filtering applied).</p>'
                               }`
                        }
                    </div>`;

                // Insert after comparable properties section (sales comparables)
                const comparablePropsSection = document.getElementById('comparable-properties-section');
                if (comparablePropsSection) {
                    comparablePropsSection.insertAdjacentHTML('afterend', sectionHtml);
                } else {
                    // Fallback: add to end if sales comparables not found
                    resultsDiv.insertAdjacentHTML('beforeend', sectionHtml);
                }
            }
            
            function renderComparableProperties(comparableProperties) {
                /**
                 * Render comparable properties table in the valuation report.
                 * @param {Array} comparableProperties - Array of comparable property objects
                 */
                const existingSection = document.getElementById('comparable-properties-section');
                if (existingSection) {
                    existingSection.remove();
                }

                const resultsDiv = document.getElementById('valuation-results');
                if (!resultsDiv) return;

                const sectionHtml = `
                    <div id="comparable-properties-section" class="comparable-properties-section">
                        <h3 style="color: #2196F3; margin: 20px 0 15px 0;">Comparable Properties Used</h3>
                        ${comparableProperties.length === 0 
                            ? '<p style="color: #666; font-style: italic;">No comparable properties available for this valuation.</p>'
                            : `<div class="table-responsive">
                                <table class="comparable-properties-table">
                                    <thead>
                                        <tr>
                                            <th>Project Name</th><th>Size (sqm)</th><th>Sale Price (AED)</th>
                                            <th>Price per sqm</th><th>Sale Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${comparableProperties.slice(0, 10).map(prop => 
                                            `<tr>
                                                <td title="${prop.project || prop.project_name || 'N/A'}">${(prop.project || prop.project_name || 'N/A').length > 30 ? (prop.project || prop.project_name || 'N/A').substring(0, 30) + '...' : (prop.project || prop.project_name || 'N/A')}</td>
                                                <td>${prop.area_sqm ? parseFloat(prop.area_sqm).toFixed(1) : 'N/A'}</td>
                                                <td>${prop.sold_price || prop.sale_price ? new Intl.NumberFormat('en-AE').format(prop.sold_price || prop.sale_price) : 'N/A'}</td>
                                                <td>${prop.price_per_sqm ? new Intl.NumberFormat('en-AE').format(Math.round(prop.price_per_sqm)) : 'N/A'}</td>
                                                <td>${prop.transaction_date || prop.sale_date ? new Date(prop.transaction_date || prop.sale_date).toLocaleDateString('en-GB') : 'N/A'}</td>
                                            </tr>`
                                        ).join('')}
                                    </tbody>
                                </table>
                                ${comparableProperties.length > 10 
                                    ? `<p style="color: #666; margin-top: 10px; font-size: 0.9em;">Showing first 10 of ${comparableProperties.length} comparable properties used in this valuation</p>`
                                    : ''}
                               </div>`
                        }
                    </div>`;

                resultsDiv.insertAdjacentHTML('beforeend', sectionHtml);
            }

            /**
             * Generate and download PDF valuation report
             */
            function generateValuationPDF() {
                try {
                    // Validate that valuation exists
                    const resultsDiv = document.getElementById('valuation-results');
                    if (!resultsDiv || resultsDiv.style.display === 'none' || !lastValuationData) {
                        alert('⚠️ Please generate a property valuation first before downloading the PDF report.');
                        return;
                    }

                    // Check if jsPDF is available
                    if (typeof window.jspdf === 'undefined') {
                        alert('❌ PDF library not loaded. Please refresh the page and try again.');
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Page setup
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 20;
                    let yPos = margin;

                    // Helper function to add new page if needed
                    const checkPageBreak = (requiredSpace) => {
                        if (yPos + requiredSpace > pageHeight - margin) {
                            doc.addPage();
                            yPos = margin;
                            return true;
                        }
                        return false;
                    };

                    // === HEADER ===
                    doc.setFillColor(33, 150, 243); // #2196F3
                    doc.rect(0, 0, pageWidth, 45, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(24);
                    doc.setFont(undefined, 'bold');
                    doc.text('Property Valuation Report', pageWidth / 2, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    const timestamp = new Date().toLocaleString('en-AE', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    doc.text(`Generated on: ${timestamp}`, pageWidth / 2, 32, { align: 'center' });
                    
                    yPos = 55;

                    // === ESTIMATED VALUE SECTION ===
                    doc.setFillColor(33, 150, 243, 0.1);
                    doc.roundedRect(margin, yPos, pageWidth - 2 * margin, 35, 3, 3, 'F');
                    
                    doc.setTextColor(33, 150, 243);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Estimated Market Value', pageWidth / 2, yPos + 10, { align: 'center' });
                    
                    const estimatedValue = lastValuationData.estimated_value;
                    const formattedValue = new Intl.NumberFormat('en-AE').format(estimatedValue);
                    doc.setFontSize(22);
                    doc.text(`AED ${formattedValue}`, pageWidth / 2, yPos + 22, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`${lastValuationData.confidence_score}% Confidence`, pageWidth / 2, yPos + 30, { align: 'center' });
                    
                    yPos += 45;

                    // === VALUATION DETAILS ===
                    checkPageBreak(40);
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Valuation Details', margin, yPos);
                    yPos += 8;

                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    
                    const pricePerSqm = new Intl.NumberFormat('en-AE').format(lastValuationData.price_per_sqm);
                    doc.text(`Price per Sq.M:`, margin + 5, yPos);
                    doc.text(`${pricePerSqm} AED/m²`, margin + 80, yPos);
                    yPos += 7;

                    const rangeMin = new Intl.NumberFormat('en-AE').format(lastValuationData.value_range.low);
                    const rangeMax = new Intl.NumberFormat('en-AE').format(lastValuationData.value_range.high);
                    doc.text(`Value Range:`, margin + 5, yPos);
                    doc.text(`${rangeMin} - ${rangeMax} AED`, margin + 80, yPos);
                    yPos += 7;

                    doc.text(`Comparable Properties:`, margin + 5, yPos);
                    doc.text(`${lastValuationData.total_comparables_found || 0} properties analyzed`, margin + 80, yPos);
                    yPos += 12;

                    // === RENTAL YIELD SECTION (NEW) ===
                    if (lastValuationData.rental_data && lastValuationData.rental_data.annual_rent) {
                        const grossYield = (lastValuationData.rental_data.annual_rent / lastValuationData.estimated_value * 100).toFixed(2);
                        
                        checkPageBreak(20);
                        
                        // Yield percentage
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'bold');
                        doc.text('Gross Rental Yield:', margin + 5, yPos);
                        doc.setFont(undefined, 'normal');
                        doc.text(`${grossYield}%`, margin + 80, yPos);
                        yPos += 6;
                        
                        // Annual rent amount
                        doc.setFontSize(9);
                        doc.setTextColor(100, 100, 100);
                        const annualRent = new Intl.NumberFormat('en-AE').format(lastValuationData.rental_data.annual_rent);
                        doc.text(`(Annual Rent: ${annualRent} AED)`, margin + 5, yPos);
                        yPos += 6;
                        
                        // Comparables count
                        const rentalSubtitle = lastValuationData.rental_data.is_city_average 
                            ? `City-wide average (${lastValuationData.rental_data.count} rentals)`
                            : `Based on ${lastValuationData.rental_data.count} rental comparables`;
                        doc.text(rentalSubtitle, margin + 5, yPos);
                        yPos += 12;
                    }
                    // === END RENTAL YIELD SECTION ===

                    // === RENTAL COMPARABLES TABLE (NEW) ===
                    if (lastValuationData.rental_data && 
                        lastValuationData.rental_data.comparables && 
                        lastValuationData.rental_data.comparables.length > 0) {
                        
                        checkPageBreak(40);
                        doc.setTextColor(102, 126, 234); // Purple theme #667eea
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('Rental Properties Used for Yield Calculation', margin, yPos);
                        yPos += 8;
                        
                        // Table header
                        doc.setFillColor(102, 126, 234); // Purple background
                        doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                        doc.setTextColor(255, 255, 255); // White text
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        
                        doc.text('Location', margin + 3, yPos + 5);
                        doc.text('Size', margin + 50, yPos + 5);
                        doc.text('Annual Rent', margin + 75, yPos + 5);
                        doc.text('Rent/sqm', margin + 115, yPos + 5);
                        doc.text('Date', margin + 145, yPos + 5);
                        yPos += 10;
                        
                        // Table rows (first 15 rentals)
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'normal');
                        const maxRentals = Math.min(15, lastValuationData.rental_data.comparables.length);
                        
                        for (let i = 0; i < maxRentals; i++) {
                            checkPageBreak(8);
                            const rental = lastValuationData.rental_data.comparables[i];
                            
                            // Alternate row colors
                            if (i % 2 === 0) {
                                doc.setFillColor(250, 250, 250);
                                doc.rect(margin, yPos - 2, pageWidth - 2 * margin, 7, 'F');
                            }
                            
                            // Location (truncate if too long)
                            const location = (rental.location || 'N/A').substring(0, 20);
                            doc.text(location, margin + 3, yPos + 3);
                            
                            // Size
                            doc.text(
                                rental.size_sqm ? `${rental.size_sqm.toFixed(0)} sqm` : 'N/A', 
                                margin + 50, 
                                yPos + 3
                            );
                            
                            // Annual Rent
                            doc.text(
                                rental.annual_rent ? new Intl.NumberFormat('en-AE', {maximumFractionDigits: 0}).format(rental.annual_rent) : 'N/A', 
                                margin + 75, 
                                yPos + 3
                            );
                            
                            // Rent per sqm
                            doc.text(
                                rental.rent_per_sqm ? new Intl.NumberFormat('en-AE', {maximumFractionDigits: 0}).format(rental.rent_per_sqm) : 'N/A', 
                                margin + 115, 
                                yPos + 3
                            );
                            
                            // Listing Date
                            let dateText = 'N/A';
                            if (rental.listing_date && rental.listing_date !== 'None' && rental.listing_date.trim() !== '') {
                                try {
                                    dateText = new Date(rental.listing_date).toLocaleDateString('en-GB');
                                } catch (e) {
                                    dateText = 'N/A';
                                }
                            }
                            doc.text(dateText, margin + 145, yPos + 3);
                            
                            yPos += 6;
                        }
                        
                        // Summary statistics box
                        yPos += 5;
                        checkPageBreak(15);
                        doc.setFillColor(245, 243, 255); // Light purple
                        doc.roundedRect(margin, yPos, pageWidth - 2 * margin, 12, 2, 2, 'F');
                        doc.setTextColor(102, 126, 234); // Purple text
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        
                        const medianRent = new Intl.NumberFormat('en-AE').format(lastValuationData.rental_data.annual_rent);
                        const rentRange = lastValuationData.rental_data.price_range ? 
                            `${new Intl.NumberFormat('en-AE').format(lastValuationData.rental_data.price_range.low)} - ${new Intl.NumberFormat('en-AE').format(lastValuationData.rental_data.price_range.high)}` : 
                            'N/A';
                        
                        doc.text(
                            `Median: ${medianRent} AED/year  |  Range: ${rentRange} AED  |  Properties: ${lastValuationData.rental_data.count}`,
                            pageWidth / 2,
                            yPos + 8,
                            { align: 'center' }
                        );
                        
                        // Data source note
                        yPos += 14;
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'italic');
                        doc.setTextColor(100, 100, 100);
                        const sourceNote = lastValuationData.rental_data.is_city_average ?
                            'Note: Using city-wide data due to insufficient area-specific rentals.' :
                            'Data source: Area-specific rental comparables with ±30% size filtering applied.';
                        doc.text(sourceNote, pageWidth / 2, yPos, { align: 'center' });
                        
                        yPos += 15;
                    }
                    // === END RENTAL COMPARABLES TABLE ===

                    // === COMPARABLE PROPERTIES TABLE ===
                    if (lastComparablesData && lastComparablesData.length > 0) {
                        checkPageBreak(50);
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(33, 150, 243);
                        doc.text('Comparable Properties Used', margin, yPos);
                        yPos += 8;

                        // Table headers
                        doc.setFillColor(240, 240, 240);
                        doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        
                        const colWidths = [60, 25, 35, 30, 25];
                        const headers = ['Project Name', 'Size (sqm)', 'Sale Price (AED)', 'Price/sqm', 'Sale Date'];
                        let xPos = margin + 2;
                        headers.forEach((header, i) => {
                            doc.text(header, xPos, yPos + 5);
                            xPos += colWidths[i];
                        });
                        yPos += 10;

                        // Table rows (limit to first 20 for space)
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(8);
                        const displayComparables = lastComparablesData.slice(0, 20);
                        
                        displayComparables.forEach((comp, index) => {
                            checkPageBreak(8);
                            
                            // Alternate row colors
                            if (index % 2 === 0) {
                                doc.setFillColor(250, 250, 250);
                                doc.rect(margin, yPos - 2, pageWidth - 2 * margin, 7, 'F');
                            }
                            
                            xPos = margin + 2;
                            const projectName = (comp.project || 'N/A').substring(0, 30);
                            doc.text(projectName, xPos, yPos + 3);
                            xPos += colWidths[0];
                            
                            doc.text(comp.area_sqm ? parseFloat(comp.area_sqm).toFixed(1) : 'N/A', xPos, yPos + 3);
                            xPos += colWidths[1];
                            
                            const salePrice = comp.sold_price ? new Intl.NumberFormat('en-AE', { maximumFractionDigits: 0 }).format(comp.sold_price) : 'N/A';
                            doc.text(salePrice, xPos, yPos + 3);
                            xPos += colWidths[2];
                            
                            const priceSqm = comp.price_per_sqm ? new Intl.NumberFormat('en-AE', { maximumFractionDigits: 0 }).format(comp.price_per_sqm) : 'N/A';
                            doc.text(priceSqm, xPos, yPos + 3);
                            xPos += colWidths[3];
                            
                            const saleDate = comp.transaction_date ? new Date(comp.transaction_date).toLocaleDateString('en-GB') : 'N/A';
                            doc.text(saleDate, xPos, yPos + 3);
                            
                            yPos += 7;
                        });

                        if (lastComparablesData.length > 20) {
                            yPos += 3;
                            doc.setFontSize(8);
                            doc.setTextColor(100, 100, 100);
                            doc.text(`Showing first 20 of ${lastComparablesData.length} comparable properties`, margin, yPos);
                            yPos += 5;
                        }
                        yPos += 10;
                    }

                    // === METHODOLOGY ===
                    checkPageBreak(40);
                    doc.setTextColor(33, 150, 243);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Valuation Methodology', margin, yPos);
                    yPos += 8;

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    const methodology = [
                        'This valuation is based on statistical analysis of comparable properties in the',
                        'same area and property type. Our algorithm considers:',
                        '',
                        '• Recent sales transactions in the area',
                        '• Property size and type similarities',
                        '• Market trends and price fluctuations',
                        '• Location-specific factors'
                    ];
                    
                    methodology.forEach(line => {
                        checkPageBreak(6);
                        doc.text(line, margin + 5, yPos);
                        yPos += 5;
                    });
                    yPos += 5;

                    // === DISCLAIMER ===
                    checkPageBreak(30);
                    doc.setTextColor(200, 0, 0);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('Important Disclaimer', margin, yPos);
                    yPos += 7;

                    doc.setTextColor(80, 80, 80);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    const disclaimer = doc.splitTextToSize(
                        'This is an automated valuation model (AVM) estimate for informational purposes only. The actual market value may vary based on property condition, unique features, market conditions, and other factors not captured in this analysis. For official property valuations, please consult with a certified real estate appraiser.',
                        pageWidth - 2 * margin - 10
                    );
                    doc.text(disclaimer, margin + 5, yPos);
                    yPos += disclaimer.length * 4 + 10;

                    // === FOOTER ===
                    const footerY = pageHeight - 15;
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text('Generated by Retyn AVM (Automated Valuation Model)', pageWidth / 2, footerY, { align: 'center' });
                    doc.text(`Page 1 of ${doc.internal.pages.length - 1}`, pageWidth - margin, footerY, { align: 'right' });

                    // Save PDF
                    const filename = `Retyn-Valuation-Report-${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(filename);

                    // Show success message
                    console.log('✅ PDF generated successfully:', filename);
                    
                } catch (error) {
                    console.error('❌ PDF Generation Error:', error);
                    alert(`Failed to generate PDF: ${error.message}. Please try again or contact support.`);
                }
            }
            
            // ============================================================================
            // PROPERTY FLIP SCORE - Quick Win Feature
            // ============================================================================
            
            async function calculateFlipScore(propertyType, area, size, bedrooms) {
                try {
                    console.log('🏗️ Calculating flip score...');
                    
                    const response = await fetch('/api/flip-score', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            property_type: propertyType,
                            area: area,
                            size_sqm: size,
                            bedrooms: bedrooms
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        console.error('❌ Flip score error:', data.error);
                        document.getElementById('flip-score-card').style.display = 'none';
                        return;
                    }
                    
                    displayFlipScore(data);
                    
                } catch (error) {
                    console.error('❌ Flip score fetch error:', error);
                    document.getElementById('flip-score-card').style.display = 'none';
                }
            }
            
            function displayFlipScore(data) {
                // Show card
                const flipCard = document.getElementById('flip-score-card');
                flipCard.style.display = 'block';
                flipCard.style.visibility = 'visible';
                flipCard.style.opacity = '1';
                
                // Update main score
                const score = data.flip_score;
                document.getElementById('flip-score-value').textContent = score;
                
                // Update circular progress
                const circumference = 2 * Math.PI * 50; // radius = 50
                const offset = circumference - (score / 100) * circumference;
                const progressCircle = document.getElementById('flip-score-progress');
                progressCircle.style.strokeDashoffset = offset;
                
                // Color code the progress circle based on score
                if (score >= 80) {
                    progressCircle.style.stroke = '#28a745'; // Green
                } else if (score >= 60) {
                    progressCircle.style.stroke = '#FFC107'; // Yellow
                } else if (score >= 40) {
                    progressCircle.style.stroke = '#FF9800'; // Orange
                } else {
                    progressCircle.style.stroke = '#F44336'; // Red
                }
                
                // Update rating and confidence
                document.getElementById('flip-score-rating').textContent = data.rating;
                document.getElementById('flip-score-confidence').textContent = data.confidence + ' Confidence';
                
                // Update breakdown bars and details
                const breakdown = data.breakdown;
                
                if (breakdown.price_appreciation) {
                    document.getElementById('appreciation-score').textContent = breakdown.price_appreciation.score;
                    document.getElementById('appreciation-bar').style.width = breakdown.price_appreciation.score + '%';
                    document.getElementById('appreciation-details').textContent = breakdown.price_appreciation.details;
                }
                
                if (breakdown.liquidity) {
                    document.getElementById('liquidity-score').textContent = breakdown.liquidity.score;
                    document.getElementById('liquidity-bar').style.width = breakdown.liquidity.score + '%';
                    document.getElementById('liquidity-details').textContent = breakdown.liquidity.details;
                }
                
                if (breakdown.rental_yield) {
                    document.getElementById('yield-score').textContent = breakdown.rental_yield.score;
                    document.getElementById('yield-bar').style.width = breakdown.rental_yield.score + '%';
                    document.getElementById('yield-details').textContent = breakdown.rental_yield.details;
                }
                
                if (breakdown.market_position) {
                    document.getElementById('segment-score').textContent = breakdown.market_position.score;
                    document.getElementById('segment-bar').style.width = breakdown.market_position.score + '%';
                    document.getElementById('segment-details').textContent = breakdown.market_position.details;
                }
                
                // Update recommendation
                document.getElementById('flip-recommendation-text').textContent = data.recommendation;
                
                // Update data quality
                const dq = data.data_quality;
                document.getElementById('flip-data-quality').textContent = 
                    `Data quality: ${dq.transactions_analyzed} transactions analyzed, ${dq.rental_comparables} rental comparables (${dq.date_range})`;
                
                // Scroll to flip score card smoothly
                setTimeout(() => {
                    flipCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 500);
                
                console.log(`✅ Flip Score: ${score}/100 (${data.rating}) - Confidence: ${data.confidence}`);
            }
            
            // ============================
            // Property Arbitrage Score Functions
            // ============================
            
            async function calculateArbitrageScore(propertyType, area, size, bedrooms, askingPrice) {
                try {
                    console.log(`📊 Calculating arbitrage score for ${propertyType} in ${area} (${size} sqm) at ${askingPrice} AED`);
                    
                    const response = await fetch('/api/arbitrage-score', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            property_type: propertyType,
                            area: area,
                            size: size,
                            bedrooms: bedrooms,
                            asking_price: askingPrice
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to calculate arbitrage score');
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        console.warn(`⚠️ Arbitrage calculation warning: ${data.error}`);
                        document.getElementById('arbitrage-card').style.display = 'none';
                        return;
                    }
                    
                    displayArbitrageScore(data);
                } catch (error) {
                    console.error('❌ Error calculating arbitrage score:', error);
                    document.getElementById('arbitrage-card').style.display = 'none';
                }
            }
            
            function displayArbitrageScore(data) {
                const card = document.getElementById('arbitrage-card');
                card.style.display = 'block';
                
                const score = Math.round(data.arbitrage_score);
                document.getElementById('arbitrage-score-value').textContent = score;
                
                // Color-code based on score
                let color, rating;
                if (score >= 80) {
                    color = '#28a745'; // Green
                    rating = 'Excellent Arbitrage';
                } else if (score >= 60) {
                    color = '#FFC107'; // Yellow
                    rating = 'Good Arbitrage';
                } else if (score >= 40) {
                    color = '#fd7e14'; // Orange
                    rating = 'Moderate Arbitrage';
                } else {
                    color = '#dc3545'; // Red
                    rating = 'Poor Arbitrage';
                }
                
                // Update circular progress
                const circle = document.getElementById('arbitrage-progress');
                const circumference = 314;
                const offset = circumference - (score / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                circle.style.stroke = color;
                
                // Update rating and confidence
                document.getElementById('arbitrage-rating').textContent = rating;
                document.getElementById('arbitrage-rating').style.color = color;
                document.getElementById('arbitrage-confidence').textContent = `Confidence: ${data.confidence}`;
                
                // Update breakdown - Rental Yield (50%)
                const breakdown = data.breakdown;
                if (breakdown && breakdown.rental_yield) {
                    const yieldScore = breakdown.rental_yield.score;
                    const yieldValue = breakdown.rental_yield.value;
                    
                    document.getElementById('arbitrage-yield-score').textContent = `${yieldScore}/50`;
                    document.getElementById('arbitrage-yield-bar').style.width = `${(yieldScore / 50) * 100}%`;
                    document.getElementById('arbitrage-yield-details').textContent = 
                        `${yieldValue.toFixed(2)}% rental yield (${breakdown.rental_yield.comparables} comparables)`;
                }
                
                // Update breakdown - Value Spread (50%)
                if (breakdown && breakdown.value_spread) {
                    const spreadScore = breakdown.value_spread.score;
                    const spreadValue = breakdown.value_spread.value;
                    
                    document.getElementById('arbitrage-spread-score').textContent = `${spreadScore}/50`;
                    document.getElementById('arbitrage-spread-bar').style.width = `${(spreadScore / 50) * 100}%`;
                    
                    let spreadText = spreadValue >= 0 
                        ? `${spreadValue.toFixed(1)}% below market (${breakdown.value_spread.comparables} comparables)`
                        : `${Math.abs(spreadValue).toFixed(1)}% above market (overpriced)`;
                    document.getElementById('arbitrage-spread-details').textContent = spreadText;
                }
                
                // Update metrics table
                document.getElementById('arbitrage-your-yield').textContent = `${data.rental_yield.toFixed(2)}%`;
                document.getElementById('arbitrage-market-rent').textContent = `AED ${data.market_rent.toLocaleString()}`;
                document.getElementById('arbitrage-asking-price').textContent = `AED ${breakdown.value_spread.asking_price.toLocaleString()}`;
                document.getElementById('arbitrage-market-value').textContent = `AED ${data.market_value.toLocaleString()}`;
                
                // Update recommendation
                let recommendation;
                if (score >= 80) {
                    recommendation = 'Excellent investment opportunity! Property is significantly undervalued with strong rental income potential.';
                    document.getElementById('arbitrage-recommendation').style.background = '#d4edda';
                    document.getElementById('arbitrage-recommendation').style.borderColor = '#28a745';
                } else if (score >= 60) {
                    recommendation = 'Good investment potential. Property offers reasonable value and rental returns.';
                    document.getElementById('arbitrage-recommendation').style.background = '#fff3cd';
                    document.getElementById('arbitrage-recommendation').style.borderColor = '#FFC107';
                } else if (score >= 40) {
                    recommendation = 'Moderate opportunity. Consider negotiating price or evaluating rental strategy.';
                    document.getElementById('arbitrage-recommendation').style.background = '#ffe5d0';
                    document.getElementById('arbitrage-recommendation').style.borderColor = '#fd7e14';
                } else {
                    recommendation = 'Limited arbitrage potential. Property may be overpriced or have low rental demand.';
                    document.getElementById('arbitrage-recommendation').style.background = '#f8d7da';
                    document.getElementById('arbitrage-recommendation').style.borderColor = '#dc3545';
                }
                document.getElementById('arbitrage-recommendation-text').textContent = recommendation;
                
                // Update data quality
                const totalComparables = (breakdown.rental_yield?.comparables || 0) + (breakdown.value_spread?.comparables || 0);
                document.getElementById('arbitrage-data-quality').textContent = 
                    `Data comparables: ${totalComparables} properties analyzed (Confidence: ${data.confidence})`;
                
                // Scroll to card
                setTimeout(() => {
                    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 500);
                
                console.log(`✅ Arbitrage Score: ${score}/100 (${rating}) - Yield: ${data.rental_yield.toFixed(2)}% - Spread: ${data.value_spread_pct.toFixed(1)}%`);
            }
            
            // Add event listener for valuation form
            document.addEventListener('DOMContentLoaded', function() {
                const valuationForm = document.getElementById('valuation-form');
                if (valuationForm) {
                    valuationForm.addEventListener('submit', submitValuation);
                }
                
                // Wire up PDF download button
                const pdfBtn = document.getElementById('download-pdf-btn');
                if (pdfBtn) {
                    pdfBtn.addEventListener('click', generateValuationPDF);
                }
            });
        </script>
    </body>
</html>
